{% load static tailwind_tags %}
{% load account %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en" x-data :data-theme="$store.theme.current">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind -->
    {% tailwind_css %}
    <!-- Marked library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Iconify -->
    <script src="https://code.iconify.design/iconify-icon/2.2.0/iconify-icon.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.14.7/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/motion@11.11.13/dist/motion.js"></script>
    <script>
        const { animate, spring, stagger } = Motion;
        
        // Enhanced spring configurations
        const smoothSpring = {
            stiffness: 80,
            damping: 20,
            mass: 0.8,
            restSpeed: 0.2
        };

        const floatySpring = {
            stiffness: 150,
            damping: 20,
            mass: 0.5,
            restSpeed: 0.5
        };

        // Combined animation presets
        const animationPresets = {
            hover: {
                scale: 1.02,
                x: 4,
                duration: 0.2,
                space: 'transform-gpu'
            },
            menuReveal: {
                opacity: [0, 1],
                scale: [0.95, 1],
                y: [-8, 0],
                duration: 0.2,
                space: 'transform-gpu'
            },
            sidebarCollapse: {
                transform: {
                    duration: 0.4,
                    easing: [0.6, 0.01, 0.05, 0.95]
                }
            },
            sidebarToggle: {
                duration: 0.4,
                easing: [0.32, 0.72, 0, 1],
                space: 'transform-gpu'
            }
        };

        // Sidebar animation orchestrator
        function animateSidebar(sidebar, content, items, isCollapsing) {
            const sidebarWidth = isCollapsing ? '5rem' : '20rem';

            return Promise.all([
                // Animate width and position together
                animate(sidebar, 
                    { width: sidebarWidth },
                    { 
                        duration: 0.4,
                        easing: [0.4, 0, 0.2, 1]
                    }
                ),
                
                // Animate text elements with fade
                animate(items, {
                    opacity: isCollapsing ? [1, 0] : [0, 1],
                    x: isCollapsing ? [0, -8] : [-8, 0]
                }, {
                    duration: 0.3,
                    delay: isCollapsing ? 0 : 0.2,
                    easing: [0.4, 0, 0.2, 1]
                }),

                // Animate content margin smoothly
                animate(content, {
                    marginLeft: sidebarWidth
                }, {
                    duration: 0.4,
                    easing: [0.4, 0, 0.2, 1]
                })
            ]);
        }

        // Define the sequence function
        function sequence(animations, options = {}) {
            return animations.reduce((promise, { el, props, opts }) => {
                return promise.then(() => animate(el, props, { ...opts, ...options }));
            }, Promise.resolve());
        }

        // Alpine initialization
        document.addEventListener('alpine:init', () => {
            Alpine.magic('motion', () => Motion.animate);

            // Sidebar store
            Alpine.store('sidebar', {
                open: window.innerWidth >= 1024,
                collapsed: JSON.parse(localStorage.getItem('sidebarCollapsed') || 'false'),

                toggle() {
                    this.open = !this.open;
                    const sidebar = document.querySelector('aside');
                    
                    if (sidebar) {
                        animate(sidebar, {
                            x: this.open ? ['-100%', '0%'] : ['0%', '-100%']
                        }, {
                            duration: 0.4,
                            easing: [0.4, 0, 0.2, 1]
                        });
                    }
                },

                collapse() {
                    this.collapsed = !this.collapsed;
                    localStorage.setItem('sidebarCollapsed', this.collapsed);
                    
                    const sidebar = document.querySelector('aside');
                    const content = document.querySelector('main');
                    const sidebarItems = document.querySelectorAll('aside .nav-item span');
                    
                    if (sidebar) {
                        const targetWidth = this.collapsed ? '5rem' : '20rem';
                        
                        // Sequence the animations for better performance
                        sequence([
                            // First animate the text
                            {
                                el: sidebarItems,
                                props: {
                                    opacity: this.collapsed ? [1, 0] : [0, 1],
                                    x: this.collapsed ? [0, -10] : [-10, 0]
                                },
                                opts: { duration: 0.2 }
                            },
                            // Then animate the sidebar with spring physics
                            {
                                el: sidebar,
                                props: {
                                    width: targetWidth,
                                    x: this.collapsed ? [-4, 0] : [0, -4, 0],
                                    scale: this.collapsed ? [1, 0.98, 1] : [1, 1.02, 1]
                                },
                                opts: { ...smoothSpring }
                            },
                            // Finally animate the content margin
                            {
                                el: content,
                                props: { marginLeft: targetWidth },
                                opts: { duration: 0.3 }
                            }
                        ], {
                            delay: this.collapsed ? 0 : 0.1
                        });
                    }
                },

                init() {
                    // ...existing init code...
                }
            });

            // Theme store
            Alpine.store('theme', {
                themes: ['Jobless', 'Jobless Dark', 'lofi', 'pastel'],
                current: localStorage.getItem('theme') || 'Jobless',

                init() {
                    this.apply();
                },

                apply() {
                    document.documentElement.setAttribute('data-theme', this.current);
                },

                toggle() {
                    // Toggle between Jobless and Jobless Dark
                    this.current = this.current === 'Jobless' ? 'Jobless Dark' : 'Jobless';
                    localStorage.setItem('theme', this.current);
                    this.apply();
                },

                set(theme) {
                    this.current = theme;
                    localStorage.setItem('theme', theme);
                    this.apply();
                }
            });

            // Define the pageState store
            Alpine.store('pageState', {
                isLoading: true,
                init() {
                    setTimeout(() => {
                        this.isLoading = false;
                    }, 100);
                }
            });

            // Initialize page state
            if (Alpine.store('pageState')) {
                Alpine.store('pageState').init();
            }

            // Add common animation presets
            Alpine.data('animations', () => ({
                hover: {
                    scale: 1.02,
                    x: 4,
                    transition: { duration: 0.2 }
                },
                click: {
                    scale: 0.95,
                    transition: { duration: 0.1 }
                },
                menuEnter: {
                    opacity: 1,
                    scale: 1,
                    y: 0,
                    transition: { duration: 0.2 }
                },
                menuLeave: {
                    opacity: 0,
                    scale: 0.95,
                    y: -10,
                    transition: { duration: 0.15 }
                }
            }));
        });

        // Add passive event listeners
        document.addEventListener('scroll', () => {}, { passive: true });
        document.addEventListener('touchstart', () => {}, { passive: true });
        document.addEventListener('touchmove', () => {}, { passive: true });
    </script>
    <title>Jobless</title>
    <style>
        [x-cloak] { display: none !important; }
        
        /* Essential animations that can't be handled by Tailwind */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Only keep minimal required custom CSS */
        .nav-item::after {
            content: '';
            @apply absolute bottom-0 left-0 right-0 h-0.5 bg-current transform scale-x-0 transition-transform duration-300;
        }
        
        .theme-preview {
            @apply w-6 h-6 rounded-full border-2 border-base-content/20 relative;
        }
        
        .theme-preview::before {
            content: '';
            @apply absolute inset-[2px] rounded-full bg-gradient-to-tr from-primary to-secondary;
        }
        
        .user-avatar::after {
            content: '';
            @apply absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full bg-success border-2 border-base-200;
        }
        
        /* Spring easing for smoother transitions */
        .ease-spring {
            transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Remove existing transition classes */
        /* 
        .content-shift {
            @apply transition-[margin,width] duration-300 ease-in-out;
        }
        
        .sidebar-slide {
            @apply transition-transform duration-300 ease-in-out;
        }
        */
        
        /* Add smooth content shifting */
        .content-shift {
            @apply transition-[margin,width] duration-300 ease-in-out;
        }
        
        /* Enhanced sidebar transitions */
        .sidebar-slide {
            @apply transition-transform duration-300 ease-in-out;
        }
    </style>
</head>

<!-- Update body class to remove overflow-hidden -->
<body x-data class="bg-base-100 min-h-screen">
    <!-- Page Loading Overlay -->
    <div x-data
         x-cloak
         x-show="$store.pageState.isLoading"
         class="page-loading"
         x-init="setTimeout(() => $el.remove(), 500)">
        <div class="flex h-full w-full items-center justify-center">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>
    </div>

    <!-- Mobile Header -->
    <header x-cloak class="lg:hidden fixed top-0 left-0 right-0 h-16 bg-base-100 z-40 border-b border-base-200 px-4">
        <div class="flex items-center justify-between h-full">
            <div class="flex items-center gap-3">
                <button @click="$store.sidebar.toggle()"
                        @mouseenter="$motion($el, 'hover')"
                        @mouseleave="$motion($el, { scale: 1, x: 0 })"
                        class="btn btn-ghost btn-circle"
                        :class="{ 'active': $store.sidebar.open }">
                    <iconify-icon icon="octicon:three-bars-16" 
                                class="text-xl transition-transform duration-300"
                                :class="{ 'rotate-90': $store.sidebar.open }">
                    </iconify-icon>
                </button>
                <span class="text-xl font-bold">Jobless</span>
            </div>
        </div>
    </header>

    <!-- Backdrop with improved touch handling -->
    <div x-show="$store.sidebar.open"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click="$store.sidebar.toggle()"
         @touchstart.passive.prevent="$store.sidebar.toggle()"
         class="fixed inset-0 bg-black/20 backdrop-blur-sm z-30 lg:hidden">
    </div>

    <!-- Sidebar with improved mobile handling -->
    <aside x-cloak
           class="fixed top-0 left-0 h-full bg-base-200/95 backdrop-blur-sm shadow-lg z-40"
           :class="{
               'w-80': !$store.sidebar.collapsed || window.innerWidth < 1024,
               'w-20': $store.sidebar.collapsed && window.innerWidth >= 1024,
               'translate-x-0': $store.sidebar.open,
               '-translate-x-full lg:translate-x-0': !$store.sidebar.open,
               'top-16 h-[calc(100vh-4rem)]': window.innerWidth < 1024,
               'top-0 h-full': window.innerWidth >= 1024
           }"
           @mouseenter="$store.sidebar.open || $store.sidebar.collapsed ? $motion($el, 'itemHover') : null"
           @mouseleave="$store.sidebar.open || $store.sidebar.collapsed ? $motion($el, { scale: 1, x: 0 }) : null">
        <!-- Sidebar Header -->
        <div class="relative flex items-center min-h-[4rem] px-4"
             :class="{ 'justify-between': !$store.sidebar.collapsed, 'justify-center': $store.sidebar.collapsed }">
            <!-- Logo -->
            <span class="text-2xl font-bold text-primary truncate"
                  x-show="!$store.sidebar.collapsed || window.innerWidth < 1024"
                  x-transition.duration.200ms>Jobless</span>
            
            <!-- Toggle Button mobile style -->
            <button @click="$store.sidebar.collapse()"
                    class="hidden lg:flex btn btn-ghost btn-circle"
                    x-show="!$store.sidebar.collapsed || window.innerWidth >= 1024">
                <iconify-icon icon="octicon:three-bars-16" 
                              class="text-xl transition-transform duration-300"
                              :class="{ 'rotate-90': $store.sidebar.collapsed }">
                </iconify-icon>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="p-2 space-y-2">
            {% for item in navigation_items %}
            <a href="{{ item.url }}"
               @mouseenter="animate($el, { scale: 1.02, translateX: 4 })"
               @mouseleave="animate($el, { scale: 1, translateX: 0 })"
               class="nav-item flex items-center p-2 rounded-lg hover:bg-base-100/50 transition-all duration-200"
               :class="{ 'justify-center': $store.sidebar.collapsed && window.innerWidth >= 1024 }">
                <iconify-icon icon="{{ item.icon }}" 
                              class="text-xl transition-transform duration-200"
                              :class="{ 'scale-110': $store.sidebar.collapsed && window.innerWidth >= 1024 }">
                </iconify-icon>
                <span x-show="!$store.sidebar.collapsed || window.innerWidth < 1024" 
                      x-transition.duration.200ms
                      class="ml-3">{{ item.label }}</span>
            </a>
            {% endfor %}

            <!-- Theme Controller -->
            <div class="theme-dropdown" 
                 x-data="{ open: false }"
                 @click.outside="open = false"
                 @keydown.escape.window="open = false">
                <button @click="open = !open"
                        @mouseenter="animate($el, { scale: 1.02, translateX: 4 })"
                        @mouseleave="animate($el, { scale: 1, translateX: 0 })"
                        class="nav-item flex items-center p-2 rounded-lg hover:bg-base-100/50 transition-all duration-200 w-full"
                        :class="{ 'justify-center': $store.sidebar.collapsed && window.innerWidth >= 1024 }">
                    <iconify-icon icon="octicon:paintbrush-24" 
                                  class="text-xl transition-transform duration-200 relative"
                                  :class="{ 'scale-110': $store.sidebar.collapsed && window.innerWidth >= 1024 }">
                    </iconify-icon>
                    <span x-show="!$store.sidebar.collapsed || window.innerWidth < 1024" 
                          x-transition.duration.200ms
                          class="ml-3">Theme</span>
                </button>
                
                <div x-show="open"
                     @before-enter="$motion($el, 'menuReveal')"
                     class="absolute z-50 mt-1 w-56 rounded-lg bg-base-200 shadow-lg ring-1 ring-base-content/10 p-1"
                     :class="{ 'left-full ml-2': $store.sidebar.collapsed, 'top-0': $store.sidebar.collapsed, 'left-0': !$store.sidebar.collapsed }">
                    <div class="p-1 space-y-1">
                        <template x-for="theme in $store.theme.themes" :key="theme">
                            <button @click="$store.theme.set(theme); open = false"
                                    @mouseenter="animate($el, { x: 4 })"
                                    @mouseleave="animate($el, { x: 0 })"
                                    class="theme-item flex items-center gap-3 w-full p-2 rounded-lg"
                                    :class="{ 'active': $store.theme.current === theme }">
                                <div class="theme-preview"></div>
                                <span x-text="theme" class="flex-1 text-left"></span>
                                <iconify-icon icon="heroicons:check" 
                                            class="text-lg transition-all duration-200 opacity-0"
                                            :class="{ '!opacity-100': $store.theme.current === theme }">
                                </iconify-icon>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </nav>

        <!-- User Section -->
        <div class="absolute bottom-0 left-0 right-0 p-4 user-section">
            {% if user.is_authenticated %}
                <div x-data="{ menuOpen: false }" 
                     class="relative"
                     @click.outside="menuOpen = false"
                     @keydown.escape.window="menuOpen = false">
                    <button @click="menuOpen = !menuOpen"
                            @mouseenter="animate($el, { scale: 1.02 })"
                            @mouseleave="animate($el, { scale: 1 })"
                            class="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-base-100/50 transition-all duration-200"
                            :class="{ 'justify-center': $store.sidebar.collapsed && window.innerWidth >= 1024 }">
                        <div class="avatar placeholder user-avatar">
                            <div class="w-10 rounded-full bg-primary text-primary-content shadow-lg">
                                <span class="text-lg font-medium">{{ user.username|first|upper }}</span>
                            </div>
                        </div>
                        <div x-show="!$store.sidebar.collapsed || window.innerWidth < 1024" 
                             x-transition.duration.200ms
                             class="flex-1 text-left">
                            <p class="font-medium leading-tight">{{ user.username }}</p>
                            <p class="text-sm text-base-content/70">Online</p>
                        </div>
                        <iconify-icon x-show="!$store.sidebar.collapsed || window.innerWidth < 1024"
                                     icon="heroicons:chevron-up-down" 
                                     class="text-base-content/50"
                                     :class="{ 'rotate-180': menuOpen }">
                        </iconify-icon>
                    </button>

                    <div x-show="menuOpen"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute bottom-full mb-2 w-full p-1 rounded-lg bg-base-200 shadow-lg ring-1 ring-base-content/10 user-menu"
                         :class="{ 'left-full ml-2 bottom-0 mb-0': $store.sidebar.collapsed }">
                        <a href="{% url 'account_logout' %}"
                           class="flex items-center gap-2 w-full p-2 rounded-lg hover:bg-base-100/50 transition-colors duration-200"
                           @mouseenter="animate($el, { x: 4 })"
                           @mouseleave="animate($el, { x: 0 })">
                            <iconify-icon icon="heroicons:arrow-left-on-rectangle"
                                        class="text-error"></iconify-icon>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            {% else %}
                <a href="{% url 'account_login' %}"
                   @mouseenter="animate($el, { scale: 1.02 })"
                   @mouseleave="animate($el, { scale: 1 })"
                   class="btn btn-primary w-full gap-2 normal-case font-medium"
                   :class="{ 'btn-circle': $store.sidebar.collapsed && window.innerWidth >= 1024 }">
                    <iconify-icon icon="heroicons:arrow-right-on-rectangle"
                                 :class="{ 'text-xl': $store.sidebar.collapsed && window.innerWidth >= 1024 }">
                    </iconify-icon>
                    <span x-show="!$store.sidebar.collapsed || window.innerWidth < 1024">Sign In</span>
                </a>
            {% endif %}
        </div>
    </aside>

    <!-- Main content with mobile header spacing -->
    <main x-cloak 
          class="min-h-screen content-shift"
          :class="{ 
              'pt-16 lg:pt-0': window.innerWidth < 1024,
              'lg:ml-80': !$store.sidebar.collapsed && window.innerWidth >= 1024,
              'lg:ml-20': $store.sidebar.collapsed && window.innerWidth >= 1024
          }">
        <!-- Page Content -->
        <div class="h-full">
            <div class="p-4">
                <div class="max-w-6xl mx-auto w-full">
                    {% block content %}
                    {% endblock %}
                </div>
            </div>
        </div>
    </main>

    <!-- Sidebar script modifications -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('sidebar', {
                open: window.innerWidth >= 1024,
                collapsed: JSON.parse(localStorage.getItem('sidebarCollapsed') || 'false'),
                
                toggle() {
                    this.open = !this.open;
                    const sidebar = document.querySelector('aside');
                    
                    if (sidebar) {
                        animate(sidebar, {
                            x: this.open ? ['-100%', '0%'] : ['0%', '-100%'],
                            opacity: this.open ? [0.5, 1] : [1, 0.5]
                        }, {
                            duration: 0.3,
                            easing: [0.32, 0.72, 0, 1]
                        });
                    }
                },
                
                collapse() {
                    this.collapsed = !this.collapsed;
                    localStorage.setItem('sidebarCollapsed', this.collapsed);
                    
                    const sidebar = document.querySelector('aside');
                    const content = document.querySelector('main');
                    const sidebarItems = document.querySelectorAll('aside .nav-item span');
                    
                    if (sidebar) {
                        const targetWidth = this.collapsed ? '5rem' : '20rem';
                        
                        // Sequence the animations for better performance
                        sequence([
                            // First animate the text
                            {
                                el: sidebarItems,
                                props: {
                                    opacity: this.collapsed ? [1, 0] : [0, 1],
                                    x: this.collapsed ? [0, -10] : [-10, 0]
                                },
                                opts: { duration: 0.2 }
                            },
                            // Then animate the sidebar with spring physics
                            {
                                el: sidebar,
                                props: {
                                    width: targetWidth,
                                    x: this.collapsed ? [-4, 0] : [0, -4, 0],
                                    scale: this.collapsed ? [1, 0.98, 1] : [1, 1.02, 1]
                                },
                                opts: { ...smoothSpring }
                            },
                            // Finally animate the content margin
                            {
                                el: content,
                                props: { marginLeft: targetWidth },
                                opts: { duration: 0.3 }
                            }
                        ], {
                            delay: this.collapsed ? 0 : 0.1
                        });
                    }
                },
                
                init() {
                    this.open = window.innerWidth >= 1024;
                    
                    // Improved resize handling
                    const handleResize = () => {
                        const isMobile = window.innerWidth < 1024;
                        if (isMobile) {
                            this.open = false;
                            this.collapsed = false;
                        } else {
                            this.open = true;
                            document.body.style.overflow = '';
                        }
                    };

                    window.addEventListener('resize', handleResize, { passive: true });
                    handleResize(); // Initial check
                    
                    // Improved mobile touch handling
                    document.addEventListener('touchstart', (e) => {
                        if (window.innerWidth < 1024 && !e.target.closest('aside')) {
                            this.open = false;
                        }
                    }, { passive: true });
                }
            });

            Alpine.store('theme', {
                themes: ['Jobless', 'Dark', 'lofi', 'pastel'],
                current: localStorage.getItem('theme') || 'Jobless',
                
                init() {
                    this.apply();
                },
                
                apply() {
                    document.documentElement.setAttribute('data-theme', this.current);
                },
                
                set(theme) {
                    this.current = theme;
                    localStorage.setItem('theme', theme);
                    this.apply();
                }
            });

            // Define the pageState store
            Alpine.store('pageState', {
                isLoading: true,
                init() {
                    setTimeout(() => {
                        this.isLoading = false;
                    }, 100);
                }
            });

            // Initialize page state
            if (Alpine.store('pageState')) {
                Alpine.store('pageState').init();
            }
        });

        // Add passive scroll handler for mobile
        document.addEventListener('scroll', () => {}, { passive: true });
        
        // Add passive touch handlers for mobile gestures
        document.addEventListener('touchstart', () => {}, { passive: true });
        document.addEventListener('touchmove', () => {}, { passive: true });
    </script>
</body>
</html>