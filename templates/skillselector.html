{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    }
    
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="skillSelector" class="relative" x-init="initSkills('{{ widget.value|default:"" }}')">
    <input type="hidden" name="{{ widget.name }}" x-ref="hiddenInput" :value="selectedSkills.join(',')">
    
    <div class="relative flex flex-col gap-2 p-2 bg-base-100 rounded-xl border border-base-300 focus-within:border-primary focus-within:ring-1 focus-within:ring-primary">
        <div class="flex flex-wrap gap-2">
            <template x-for="skill in selectedSkills" :key="skill">
                <span class="inline-flex items-center gap-1 px-2 py-1 bg-primary/10 text-primary rounded-lg text-sm">
                    <iconify-icon :icon="getSkillIcon(skill)" class="mr-1"></iconify-icon>
                    <span x-text="skill"></span>
                    <button type="button" @click="removeSkill(skill)" class="hover:text-error">
                        <iconify-icon icon="octicon:x-16"></iconify-icon>
                    </button>
                </span>
            </template>
        </div>

        <div class="flex items-center gap-2">
            <div class="relative flex-1">
                <input type="text"
                    x-model="searchQuery"
                    @focus="showSuggestions = true"
                    @keydown.enter.prevent="handleEnter"
                    @keydown.down.prevent="navigateSuggestion(1)"
                    @keydown.up.prevent="navigateSuggestion(-1)"
                    @keydown.escape="closeSuggestions"
                    placeholder="Search skills..."
                    class="w-full border-0 bg-transparent focus:ring-0 text-sm placeholder:text-base-content/50">
            </div>
            <button type="button" 
                    @click="toggleSkillBrowser"
                    class="btn btn-ghost btn-sm tooltip tooltip-left"
                    data-tip="Browse all skills">
                <iconify-icon icon="octicon:list-unordered-16"></iconify-icon>
            </button>
        </div>
    </div>

    <div x-show="showSuggestions && filteredSkills.length > 0"
         x-transition
         @click.away="closeSuggestions"
         class="absolute z-50 w-full mt-1 bg-base-100 rounded-lg shadow-lg border border-base-300 max-h-48 overflow-y-auto custom-scrollbar">
        <div class="py-1">
            <template x-for="(skill, index) in filteredSkills" :key="skill.name">
                <button type="button"
                    @click="selectSkill(skill.name)"
                    :class="{
                        'block w-full px-4 py-2 text-sm hover:bg-base-200 text-left': true,
                        'bg-base-200': index === selectedIndex
                    }">
                    <span class="inline-flex items-center">
                        <iconify-icon :icon="getSkillIcon(skill.name)" class="mr-2"></iconify-icon>
                        <span x-text="skill.name"></span>
                    </span>
                </button>
            </template>
        </div>
    </div>

    <dialog id="skillBrowser" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">Browse Skills</h3>
            <div class="flex flex-col gap-4">
                <div class="flex gap-2">
                    <input type="text"
                        x-model="browserSearch"
                        placeholder="Filter skills..."
                        class="input input-bordered flex-1">
                    <select x-model="selectedCategory" class="select select-bordered">
                        <option value="">All Categories</option>
                        <template x-for="category in categories" :key="category">
                            <option x-text="category" :value="category"></option>
                        </template>
                    </select>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-96 overflow-y-auto custom-scrollbar">
                    <template x-for="skill in filteredBrowserSkills" :key="skill.name">
                        <button type="button"
                            @click="selectSkill(skill.name)"
                            class="flex items-center gap-2 p-2 rounded-lg hover:bg-base-200 text-sm text-left">
                            <iconify-icon :icon="getSkillIcon(skill.name)"></iconify-icon>
                            <span x-text="skill.name"></span>
                        </button>
                    </template>
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Close</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
<script src="{% static 'js/skill-icons.js' %}"></script>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('skillSelector', () => ({
        selectedSkills: [],
        searchQuery: '',
        showSuggestions: false,
        selectedIndex: -1,
        browserSearch: '',
        selectedCategory: '',
        skillsList: [],
        categories: [],
        isDarkMode: window.matchMedia('(prefers-color-scheme: dark)').matches,

        async init() {
            // Initialize dark mode listener
            window.matchMedia('(prefers-color-scheme: dark)')
                .addEventListener('change', e => {
                    this.isDarkMode = e.matches;
                });
            
            // Wait for skills data to load
            await window.skillsHelper.initialize();
            this.skillsList = window.skillsHelper._skills.map(skill => ({
                icon: skill.icon,
                name: skill.text
            }));
            this.categories = window.skillsHelper.getCategories();
        },

        initSkills(initialValue) {
            if (initialValue) {
                this.selectedSkills = initialValue.split(',').map(s => s.trim());
            }
        },

        getSkillIcon(skillName) {
            const skill = this.skillsList.find(s => s.name === skillName);
            if (!skill) return 'octicon:code-16';
            
            const baseIcon = skill.icon;
            if (this.isDarkMode && baseIcon.startsWith('skill-icons:')) {
                return `${baseIcon}-dark`;
            }
            return baseIcon;
        },

        get filteredSkills() {
            return this.skillsList
                .filter(skill => 
                    skill.name.toLowerCase().includes(this.searchQuery.toLowerCase()) &&
                    !this.selectedSkills.includes(skill.name)
                )
                .slice(0, 5);
        },

        get filteredBrowserSkills() {
            return this.skillsList.filter(skill => {
                const matchesSearch = skill.name
                    .toLowerCase()
                    .includes(this.browserSearch.toLowerCase());
                const matchesCategory = !this.selectedCategory ||
                    skill.icon.startsWith(this.selectedCategory + ':');
                return matchesSearch && matchesCategory;
            });
        },

        selectSkill(skill) {
            if (!this.selectedSkills.includes(skill)) {
                this.selectedSkills.push(skill);
                this.searchQuery = '';
                this.selectedIndex = -1;
            }
        },

        removeSkill(skill) {
            this.selectedSkills = this.selectedSkills.filter(s => s !== skill);
        },

        handleEnter() {
            const selectedSkill = this.filteredSkills[this.selectedIndex];
            if (selectedSkill) {
                this.selectSkill(selectedSkill.name);
            } else if (this.searchQuery && !this.selectedSkills.includes(this.searchQuery)) {
                this.selectSkill(this.searchQuery);
            }
            this.closeSuggestions();
        },

        navigateSuggestion(direction) {
            const newIndex = this.selectedIndex + direction;
            if (newIndex >= -1 && newIndex < this.filteredSkills.length) {
                this.selectedIndex = newIndex;
            }
        },

        closeSuggestions() {
            this.showSuggestions = false;
            this.selectedIndex = -1;
        },

        toggleSkillBrowser() {
            document.getElementById('skillBrowser').showModal();
        }
    }));
});
</script>
{% endblock %}
