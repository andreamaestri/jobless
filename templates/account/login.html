{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block head_title %}{% trans "Sign In" %}{% endblock %}

{% block content %}
<div class="h-[calc(100vh-2rem)] w-full flex items-center justify-center p-4" 
     x-data="{ 
        showPassword: false, 
        loading: false,
        showMessage: true,
        formData: {
            login: '',
            password: '',
            remember: false
        },
        async handleSubmit() {
            if (this.loading) return;
            this.loading = true;
            this.showMessage = true;
            await new Promise(resolve => setTimeout(resolve, 100));
            this.$refs.loginForm.submit();
        }
     }">
    <div class="w-full max-w-sm mx-auto">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h1 class="text-3xl font-bold text-center text-primary">{% trans "Welcome Back" %}</h1>
                
                <form method="POST" 
                      action="{% url 'account_login' %}" 
                      x-ref="loginForm"
                      @submit.prevent="handleSubmit()"
                      class="space-y-4">
                    {% csrf_token %}

                    <!-- Messages -->
                    {% if form.errors or messages %}
                    <div x-show="showMessage"
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform -translate-y-2"
                         x-transition:enter-end="opacity-100 transform translate-y-0"
                         x-transition:leave="transition ease-in duration-200"
                         x-transition:leave-start="opacity-100 transform translate-y-0"
                         x-transition:leave-end="opacity-0 transform -translate-y-2">
                        
                        {% if form.errors %}
                        <div class="alert alert-error shadow-lg" role="alert">
                            <div class="flex items-center gap-2">
                                <iconify-icon icon="octicon:stop-16" class="w-6 h-6"></iconify-icon>
                                <div class="flex flex-col">
                                    <span class="font-bold">{% trans "Login Failed" %}</span>
                                    <span class="text-sm">
                                        {% if form.non_field_errors %}
                                            {{ form.non_field_errors.0 }}
                                        {% else %}
                                            {% trans "Invalid email/username or password." %}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            <button @click="showMessage = false" class="btn btn-ghost btn-xs">
                                <iconify-icon icon="octicon:x-16"></iconify-icon>
                            </button>
                        </div>
                        {% endif %}

                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} shadow-lg" role="alert">
                            <div class="flex items-center gap-2">
                                <iconify-icon icon="octicon:info-16" 
                                            class="w-6 h-6 {% if message.tags == 'success' %}text-success{% endif %}">
                                </iconify-icon>
                                <span>{{ message }}</span>
                            </div>
                            <button @click="showMessage = false" class="btn btn-ghost btn-xs">
                                <iconify-icon icon="octicon:x-16"></iconify-icon>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Email/Username Field -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-base-content/80">{% trans "Email or Username" %}</span>
                        </label>
                        <input type="text" 
                               name="login" 
                               id="id_login" 
                               x-model="formData.login"
                               :disabled="loading"
                               class="input input-bordered focus:border-primary focus:ring-1 focus:ring-primary disabled:bg-base-200" 
                               placeholder="{% trans 'Enter your email or username' %}"
                               {% if form.login.value %}value="{{ form.login.value }}"{% endif %}
                               required />
                        {% if form.login.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.login.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>

                    <!-- Password Field with Toggle -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-base-content/80">{% trans "Password" %}</span>
                        </label>
                        <div class="relative">
                            <input :type="showPassword ? 'text' : 'password'"
                                   name="password" 
                                   id="id_password"
                                   x-model="formData.password"
                                   :disabled="loading"
                                   class="input input-bordered w-full pr-10 focus:border-primary focus:ring-1 focus:ring-primary disabled:bg-base-200" 
                                   required />
                            <button type="button" 
                                    @click="showPassword = !showPassword" 
                                    :disabled="loading"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-sm btn-circle disabled:bg-transparent">
                                <iconify-icon :icon="showPassword ? 'octicon:eye-closed-24' : 'octicon:eye-24'"
                                            class="transition-opacity"
                                            :class="loading ? 'opacity-50' : 'opacity-100'">
                                </iconify-icon>
                            </button>
                        </div>
                        {% if form.password.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.password.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>

                    <!-- Options Row -->
                    <div class="flex items-center justify-between text-base-content/80">
                        <label class="label cursor-pointer gap-2" :class="{ 'cursor-not-allowed': loading }">
                            <input type="checkbox" 
                                   name="remember" 
                                   id="id_remember" 
                                   x-model="formData.remember"
                                   :disabled="loading"
                                   class="checkbox checkbox-primary checkbox-sm" />
                            <span class="label-text" :class="{ 'opacity-50': loading }">{% trans "Remember me" %}</span>
                        </label>
                        <a href="{% url 'account_reset_password' %}" 
                           class="link link-primary link-hover text-sm">
                            {% trans "Forgot Password?" %}
                        </a>
                    </div>

                    {% if redirect_field_value %}
                    <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}" />
                    {% endif %}

                    <!-- Submit Button -->
                    <button type="submit" 
                            class="btn btn-primary w-full hover:bg-primary/90" 
                            :disabled="loading || !formData.login || !formData.password">
                        <div class="flex items-center justify-center gap-2">
                            <span class="loading loading-spinner loading-sm" 
                                  x-cloak 
                                  x-show="loading"></span>
                            <span x-text="loading ? '{% trans "Verifying..." %}' : '{% trans "Sign In" %}'"></span>
                        </div>
                    </button>

                    <!-- Sign Up Link -->
                    <div class="text-center">
                        <p class="text-sm text-base-content/70">
                            {% blocktrans %}
                            New here?
                            <a href="{{ signup_url }}" class="link link-primary font-medium">Create an account</a>
                            {% endblocktrans %}
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}