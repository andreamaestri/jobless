{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block head_title %}{% trans "Sign In" %}{% endblock %}

{% block content %}
<div class="flex-1 w-full min-h-full flex items-center justify-center" 
     x-data="{ 
        showPassword: false, 
        loading: false,
        formData: {
            login: '',
            password: '',
            remember: false
        }
     }">
    <div class="w-full sm:max-w-sm mx-auto min-h-full sm:min-h-0">
        <div class="card bg-primary shadow-xl min-h-full sm:min-h-0 rounded-none sm:rounded-2xl">
            <div class="card-body justify-center text-primary-content">
                <h1 class="text-3xl font-bold text-center">{% trans "Welcome Back" %}</h1>
                
                <form method="POST" 
                      action="{% url 'account_login' %}" 
                      class="space-y-4">
                    {% csrf_token %}

                    <!-- Messages -->
                    {% if form.errors or messages %}
                    <div x-data="{ show: true }"
                         x-show="show"
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform -translate-y-2"
                         x-transition:enter-end="opacity-100 transform translate-y-0"
                         x-transition:leave="transition ease-in duration-200"
                         x-transition:leave-start="opacity-100 transform translate-y-0"
                         x-transition:leave-end="opacity-0 transform -translate-y-2">
                        
                        {% if form.errors %}
                        <div class="alert alert-error shadow-lg" role="alert">
                            <div class="flex items-center gap-2">
                                <iconify-icon icon="octicon:stop-16" class="w-6 h-6"></iconify-icon>
                                <div class="flex flex-col">
                                    <span class="font-bold">{% trans "Login Failed" %}</span>
                                    <span class="text-sm">
                                        {% if form.non_field_errors %}
                                            {{ form.non_field_errors.0 }}
                                        {% else %}
                                            {% trans "Invalid email/username or password." %}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            <button type="button" @click.prevent="show = false" class="btn btn-ghost btn-xs">
                                <iconify-icon icon="octicon:x-16"></iconify-icon>
                            </button>
                        </div>
                        {% endif %}

                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} shadow-lg" role="alert">
                            <div class="flex items-center gap-2">
                                <iconify-icon icon="octicon:info-16" 
                                            class="w-6 h-6 {% if message.tags == 'success' %}text-success{% endif %}">
                                </iconify-icon>
                                <span>{{ message }}</span>
                            </div>
                            <button type="button" @click.prevent="show = false" class="btn btn-ghost btn-xs">
                                <iconify-icon icon="octicon:x-16"></iconify-icon>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Email/Username Field -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-primary-content/90">{{ form.login.label }}</span>
                        </label>
                        <input type="text"
                               name="{{ form.login.name }}"
                               id="{{ form.login.id_for_label }}"
                               :disabled="loading"
                               class="input bg-primary-content/10 input-bordered border-primary-content/20 focus:border-primary-content focus:ring-1 focus:ring-primary-content disabled:bg-primary-content/5 text-primary-content placeholder-primary-content/50"
                               placeholder="{% trans 'Enter your email or username' %}"
                               {% if form.login.value %}value="{{ form.login.value }}"{% endif %}
                               required />
                        {% if form.login.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.login.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>

                    <!-- Password Field with Toggle -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-primary-content/90">{{ form.password.label }}</span>
                        </label>
                        <div class="relative">
                            <input :type="showPassword ? 'text' : 'password'"
                                   name="{{ form.password.name }}"
                                   id="{{ form.password.id_for_label }}"
                                   :disabled="loading"
                                   class="input bg-primary-content/10 input-bordered border-primary-content/20 w-full pr-10 focus:border-primary-content focus:ring-1 focus:ring-primary-content disabled:bg-primary-content/5 text-primary-content"
                                   required />
                            <button type="button"
                                    @click="showPassword = !showPassword"
                                    :disabled="loading"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-sm btn-circle text-primary-content disabled:bg-transparent">
                                <iconify-icon :icon="showPassword ? 'octicon:eye-closed-24' : 'octicon:eye-24'"
                                              class="transition-opacity"
                                              :class="loading ? 'opacity-50' : 'opacity-100'">
                                </iconify-icon>
                            </button>
                        </div>
                        {% if form.password.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.password.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>

                    <!-- Options Row -->
                    <div class="flex items-center justify-between text-primary-content/90">
                        <label class="label cursor-pointer gap-2" :class="{ 'cursor-not-allowed': loading }">
                            <input type="checkbox" 
                                   name="remember" 
                                   id="id_remember" 
                                   x-model="formData.remember"
                                   :disabled="loading"
                                   class="checkbox checkbox-primary checkbox-sm" />
                            <span class="label-text text-primary-content/90" :class="{ 'opacity-50': loading }">{% trans "Remember me" %}</span>
                        </label>
                        <a href="{% url 'account_reset_password' %}" 
                           class="link link-hover text-primary-content/90 hover:text-primary-content text-sm">
                            {% trans "Forgot Password?" %}
                        </a>
                    </div>

                    {% if redirect_field_value %}
                    <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}" />
                    {% endif %}

                    <!-- Submit Button -->
                    <button type="submit" 
                            class="btn bg-primary-content text-primary hover:bg-primary-content/90 w-full border-none" 
                            :disabled="loading">
                        <div class="flex items-center justify-center gap-2">
                            <span class="loading loading-spinner loading-sm" 
                                  x-cloak 
                                  x-show="loading"></span>
                            <span x-text="loading ? '{% trans "Verifying..." %}' : '{% trans "Sign In" %}'"></span>
                        </div>
                    </button>

                    <!-- Sign Up Link -->
                    <div class="text-center">
                        <p class="text-sm text-primary-content/80">
                            {% blocktrans %}
                            New here?
                            <a href="{{ signup_url }}" class="link hover:text-primary-content font-medium">Create an account</a>
                            {% endblocktrans %}
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}