{% include "jobs/includes/skill_base.html" %}

<!-- Modal wrapper -->
<div x-data="skillsModal"
     x-init="init()"
     x-show="modal.open"
     x-cloak
     @open-skills-modal.window="store.openModal()"
     @keydown.escape.window="store.closeModal()"
     class="modal"
     :class="{ 'modal-open': modal.open }">
    
    <!-- Backdrop -->
    <div x-show="modal.open"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm"
         @click="store.closeModal()"
         aria-hidden="true"></div>

    <!-- Modal content -->
    <div x-show="modal.open"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         class="modal-box relative w-11/12 max-w-5xl mx-auto rounded-2xl overflow-hidden bg-base-100 shadow-xl flex flex-col"
         :class="{'h-[100vh]': isMobile, 'h-[90vh]': !isMobile}"
         @click.stop>
        
        <!-- Header -->
        <div class="sticky top-0 z-[90] px-4 sm:px-6 py-3 sm:py-4 bg-base-100/95 backdrop-blur-md border-b border-base-200"
             :class="{'shadow-lg': $store.app.skills.search}">
            <div class="flex items-center gap-3 sm:gap-6">
                <!-- Mobile back button -->
                <button @click="store.closeModal()" 
                        class="btn btn-ghost btn-sm sm:hidden">
                    <iconify-icon icon="heroicons:arrow-left" class="text-xl"></iconify-icon>
                </button>
                
                <!-- Title -->
                <h3 class="text-lg sm:text-xl font-bold whitespace-nowrap items-center gap-2"
                    :class="{'hidden': isMobile && isSearchFocused}">
                    <span class="hidden sm:inline-flex items-center gap-2">
                        <iconify-icon icon="heroicons:academic-cap" class="text-primary text-2xl"></iconify-icon>
                        Manage Skills
                    </span>
                    <span class="sm:hidden">Skills</span>
                </h3>

                <!-- Search -->
                <div class="relative flex-1 max-w-lg mx-auto">
                    <div class="relative">
                        <input type="text" 
                               x-model="$store.app.skills.search"
                               @input="handleSearch($event.target.value)"
                               placeholder="Search skills..."
                               class="input input-bordered w-full pl-11 pr-4 h-10 sm:h-12 bg-base-200/50 focus:bg-base-200 transition-colors">
                        <iconify-icon icon="heroicons:magnifying-glass" 
                                      class="absolute left-4 top-1/2 -translate-y-1/2 text-xl text-base-content/60">
                        </iconify-icon>
                        <button x-show="$store.app.skills.search"
                                @click="$store.app.skills.search = ''"
                                class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-xs btn-circle">
                            <iconify-icon icon="heroicons:x-mark" class="text-base"></iconify-icon>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 min-h-0">
            <div class="flex h-full overflow-hidden">
                <!-- Skills grid -->
                <div class="flex-1 overflow-y-auto bg-base-300 px-4 sm:px-6 pb-32 scroll-smooth overscroll-contain" 
                     x-ref="skillsContainer">
                    
                    <!-- Empty state -->
                    <div x-show="$store.app.skills.search && !$store.app.skills.filteredSkills.length"
                         class="py-12 text-center text-base-content/60">
                        <iconify-icon icon="heroicons:magnifying-glass" class="text-4xl mb-4"></iconify-icon>
                        <p class="text-sm">No skills found matching "<span x-text="$store.app.skills.search"></span>"</p>
                    </div>

                    <!-- Skill groups -->
                    {% for group in skill_icons %}
                    <div class="skill-group" data-letter="{{ group.letter }}"
                         x-show="!$store.app.skills.search || {{ group.skills|tojson }}.some(s => s.name.toLowerCase().includes($store.app.skills.search.toLowerCase()))">
                        <div class="sticky bg-base-200 rounded-xl top-0 p-3 mb-4 z-[40] border-b border-base-200/30 backdrop-blur-md">
                            <div class="flex items-center gap-3">
                                <span class="text-4xl font-black text-primary">{{ group.letter }}</span>
                                <div class="h-px flex-1 bg-gradient-to-r from-base-300 to-transparent"></div>
                            </div>
                        </div>
                        <div class="grid gap-2 sm:gap-3 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                            {% for skill in group.skills %}
                            <button type="button"
                                    class="skill-card group bg-base-100 hover:bg-base-200 active:bg-base-300
                                           transition-all duration-200 rounded-xl p-3 sm:p-4 flex items-center
                                           gap-3 sm:gap-4 relative shadow-sm hover:shadow-md
                                           focus:outline-none focus:ring-2 focus:ring-primary/50"
                                    :class="{
                                        'selected': $store.app.skills.has('{{ skill.name }}'),
                                        'transform active:scale-95': isMobile
                                    }"
                                    x-show="!$store.app.skills.search || '{{ skill.name }}'.toLowerCase().includes($store.app.skills.search.toLowerCase())"
                                    @click="$store.app.skills.add({{ skill|tojson }})">
                                <div class="icon-wrapper">
                                    <iconify-icon :icon="$store.app.skills.getDarkIconForSkill('{{ skill.name }}')"
                                                 width="45" 
                                                 height="45">
                                    </iconify-icon>
                                </div>
                                <span class="skill-name p-2">{{ skill.name }}</span>
                                <div class="check-indicator">
                                    <iconify-icon icon="heroicons:check-circle" class="text-xl"></iconify-icon>
                                </div>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="fixed bottom-0 inset-x-0 z-[80] px-4 sm:px-6 py-3 sm:py-4 bg-base-100/95 backdrop-blur-lg border-t border-base-200 shadow-lg">
            <div class="flex items-center justify-between sm:justify-end gap-3">
                <span class="text-base-content/60 text-sm whitespace-nowrap">
                    <span x-text="$store.app.skills.selected.length"></span> selected
                </span>
                <div class="flex gap-2 sm:gap-3">
                    <button @click="store.closeModal()"
                            type="button"
                            class="btn btn-sm sm:btn-md btn-ghost hover:bg-error/10 hover:text-error">
                        Cancel
                    </button>
                    <button @click="save()"
                            type="button"
                            class="btn btn-sm sm:btn-md btn-primary min-w-[100px]"
                            :disabled="!store.selected.length">
                        Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
[x-cloak] { display: none !important; }

@media (max-width: 640px) {
    .skill-card {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    
    .skill-card:active {
        transform: scale(0.98);
    }
}

.overscroll-contain {
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
}
</style>
