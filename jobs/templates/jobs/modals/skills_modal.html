{% include "jobs/includes/skill_base.html" %}

<!-- Modal wrapper -->
<div x-data="skillsModal"
     x-init="init()"
     x-show="open"
     x-cloak
     @open-skills-modal.window="open = true"
     @keydown.escape.window="cancel()"
     class="modal"
     :class="{ 'modal-open': open }">
    
    <!-- Backdrop -->
    <div x-show="open"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm"
         @click="cancel()"
         aria-hidden="true"></div>

    <!-- Modal content -->
    <div x-show="open"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         class="modal-box relative w-11/12 max-w-5xl mx-auto rounded-2xl overflow-hidden bg-base-100 shadow-xl flex flex-col"
         :class="{'h-[100vh]': isMobile, 'h-[90vh]': !isMobile}"
         @click.stop>
        
        <!-- Header -->
        <div class="sticky top-0 z-[90] px-4 sm:px-6 py-3 sm:py-4 bg-base-100/95 backdrop-blur-md border-b border-base-200"
             :class="{'shadow-lg': search}">
            <div class="flex items-center gap-3 sm:gap-6">
                <!-- Mobile back button -->
                <button @click="cancel()" 
                        class="btn btn-ghost btn-sm sm:hidden">
                    <iconify-icon icon="heroicons:arrow-left" class="text-xl"></iconify-icon>
                </button>
                
                <!-- Title -->
                <h3 class="text-lg sm:text-xl font-bold whitespace-nowrap items-center gap-2"
                    :class="{'hidden': isMobile && isSearchFocused}">
                    <span class="hidden sm:inline-flex items-center gap-2">
                        <iconify-icon icon="heroicons:academic-cap" class="text-primary text-2xl"></iconify-icon>
                        Manage Skills
                    </span>
                    <span class="sm:hidden">Skills</span>
                </h3>

                <!-- Search -->
                <div class="relative flex-1 max-w-lg mx-auto" 
                     x-data="skillSelector"
                     x-init="init()">
                    <div class="relative">
                        <input type="text" 
                               x-model="searchQuery"
                               @focus="showSuggestions = true"
                               @blur="setTimeout(() => closeSuggestions(), 200)"
                               @keydown.down.prevent="navigateSuggestion(1)"
                               @keydown.up.prevent="navigateSuggestion(-1)"
                               @keydown.enter.prevent="handleEnter"
                               @keydown.escape="closeSuggestions"
                               placeholder="Search skills..."
                               class="input input-bordered w-full pl-11 pr-4 h-10 sm:h-12 bg-base-200/50 focus:bg-base-200 transition-colors">
                        <iconify-icon icon="heroicons:magnifying-glass" 
                                      class="absolute left-4 top-1/2 -translate-y-1/2 text-xl text-base-content/60">
                        </iconify-icon>
                        <button x-show="searchQuery"
                                @click="searchQuery = ''"
                                class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-xs btn-circle">
                            <iconify-icon icon="heroicons:x-mark" class="text-base"></iconify-icon>
                        </button>
                    </div>
                    
                    <!-- Suggestions dropdown -->
                    <div x-show="showSuggestions && suggestions.length > 0"
                         x-transition
                         class="absolute mt-2 w-full bg-base-100 rounded-xl shadow-lg border border-base-300 overflow-hidden z-50">
                        <ul class="max-h-64 overflow-y-auto">
                            <template x-for="(suggestion, index) in suggestions" :key="suggestion[1]">
                                <li @click="addSkill({name: suggestion[1], icon: suggestion[0]})"
                                    :class="{'bg-primary/10': selectedIndex === index}"
                                    class="p-3 hover:bg-base-200 cursor-pointer flex items-center gap-3">
                                    <iconify-icon :icon="suggestion[0]" class="text-2xl"></iconify-icon>
                                    <span x-text="suggestion[1]"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 min-h-0">
            <div class="flex h-full overflow-hidden">
                <!-- Skills grid -->
                <div class="flex-1 overflow-y-auto bg-base-300 px-4 sm:px-6 pb-32 scroll-smooth overscroll-contain" 
                     x-ref="skillsContainer"
                     @scroll.throttle.50ms="handleScroll($event)">
                    
                    <!-- Empty state -->
                    <div x-show="search && !getVisibleSkillCount()"
                         class="py-12 text-center text-base-content/60">
                        <iconify-icon icon="heroicons:magnifying-glass" class="text-4xl mb-4"></iconify-icon>
                        <p class="text-sm">No skills found matching "<span x-text="search"></span>"</p>
                    </div>

                    <!-- Skill groups -->
                    {% for group in skill_icons %}
                    <div class="skill-group" data-letter="{{ group.letter }}"
                         x-show="!search || group.skills.some(s => s.name.toLowerCase().includes(search.toLowerCase()))">
                        <div class="sticky bg-base-200 rounded-xl top-0 p-3 mb-4 z-[40] border-b border-base-200/30 backdrop-blur-md">
                            <div class="flex items-center gap-3">
                                <span class="text-4xl font-black text-primary">{{ group.letter }}</span>
                                <div class="h-px flex-1 bg-gradient-to-r from-base-300 to-transparent"></div>
                            </div>
                        </div>
                        <div class="grid gap-2 sm:gap-3 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                            {% for skill in group.skills %}
                            <button type="button"
                                    x-data="skillCard()"
                                    class="skill-card group bg-base-100 hover:bg-base-200 active:bg-base-300
                                           transition-all duration-200 rounded-xl p-3 sm:p-4 flex items-center
                                           gap-3 sm:gap-4 relative shadow-sm hover:shadow-md
                                           focus:outline-none focus:ring-2 focus:ring-primary/50"
                                    :class="{
                                        'selected': isSelected('{{ skill.name }}'),
                                        'transform active:scale-95': isMobile
                                    }"
                                    x-show="!search || '{{ skill.name }}'.toLowerCase().includes(search.toLowerCase())"
                                    x-data='{ skill: {{ skill|tojson }} }'
                                    @click="toggleSkill(skill)">
                                <div class="icon-wrapper">
                                    <iconify-icon :icon="getDarkIconForSkill('{{ skill.name }}')"
                                                 width="45" 
                                                 height="45">
                                    </iconify-icon>
                                </div>
                                <span class="skill-name p-2">{{ skill.name }}</span>
                                <div class="check-indicator">
                                    <iconify-icon icon="heroicons:check-circle" class="text-xl"></iconify-icon>
                                </div>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="fixed bottom-0 inset-x-0 z-[80] px-4 sm:px-6 py-3 sm:py-4 bg-base-100/95 backdrop-blur-lg border-t border-base-200 shadow-lg">
            <div class="flex items-center justify-between sm:justify-end gap-3">
                <span class="text-base-content/60 text-sm whitespace-nowrap">
                    <span x-text="$store.skills.selected.length"></span> selected
                </span>
                <div class="flex gap-2 sm:gap-3">
                    <button @click="cancel()"
                            type="button"
                            class="btn btn-sm sm:btn-md btn-ghost hover:bg-error/10 hover:text-error">
                        Cancel
                    </button>
                    <button @click="save()"
                            type="button"
                            class="btn btn-sm sm:btn-md btn-primary min-w-[100px]"
                            :disabled="!selectedSkills.length">
                        Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
[x-cloak] { display: none !important; }

@media (max-width: 640px) {
    .skill-card {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    
    .skill-card:active {
        transform: scale(0.98);
    }
}

.overscroll-contain {
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
}
</style>
