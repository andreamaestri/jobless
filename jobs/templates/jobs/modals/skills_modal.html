{% load job_tags %}

<div x-data="{
    open: false,
    search: '',
    selectedSkills: [],
    currentLetter: null,
    touchStartY: null,
    touchStartTime: null,
    currentPreviewLetter: null,
    lastTouchY: null,
    isScrolling: false,
    mouseX: 0,
    mouseY: 0,
    lastMouseX: 0,
    lastMouseY: 0,
    
    init() {
        this.$watch('open', value => {
            if (value) {
                this.search = '';
                this.selectedSkills = window.skillSelect?.items.map(name => ({
                    name: name,
                    ...window.skillSelect.options[name]
                })) || [];
            } else {
                window.skillsManager?.resetModalState();
            }
        });
    },

    handleSkillsUpdate(e) {
        if (e?.detail?.selectedSkills) {
            this.selectedSkills = e.detail.selectedSkills;
        }
        this.open = true;
    },

    toggleSkill(skill) {
        const index = this.selectedSkills.findIndex(s => s.name === skill.name);
        if (index === -1) {
            this.selectedSkills.push(skill);
        } else {
            this.selectedSkills.splice(index, 1);
        }
    },

    cancel() {
        this.open = false;
        this.search = '';
        // Restore original selections
        if (window.skillSelect) {
            this.selectedSkills = window.skillSelect.items.map(name => ({
                name: name,
                ...window.skillSelect.options[name]
            }));
        }
    },

    save() {
        // Ensure we're sending the complete skill objects
        const skillsToUpdate = this.selectedSkills.map(skill => ({
            name: skill.name,
            icon: skill.icon,
            icon_dark: skill.icon_dark
        }));
        
        this.$dispatch('skills-updated', skillsToUpdate);
        this.cancel();
    },

    isSelected(skillName) {
        return this.selectedSkills.some(s => s.name === skillName);
    },

    jumpToLetter(letter) {
        const group = this.$refs.skillsContainer.querySelector(`[data-letter='${letter}']`);
        if (group) {
            this.currentLetter = letter;
            group.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    },

    handleQuickSelect(event, skill) {
        if (event.shiftKey && this.lastSelected) {
            // Get all skills between last selected and current
            const skills = Array.from(this.$refs.skillsContainer.querySelectorAll('[data-skill]'));
            const start = skills.findIndex(s => s.dataset.name === this.lastSelected.name);
            const end = skills.findIndex(s => s.dataset.name === skill.name);
            const range = skills.slice(Math.min(start, end), Math.max(start, end) + 1);
            
            range.forEach(skillEl => {
                const skillData = JSON.parse(skillEl.dataset.skill);
                if (!this.isSelected(skillData.name)) {
                    this.toggleSkill(skillData);
                }
            });
        } else {
            this.toggleSkill(skill);
            this.lastSelected = skill;
        }
    },

    handleTouchStart(event) {
        this.touchStartY = event.touches[0].clientY;
        this.touchStartTime = Date.now();
    },

    handleTouchMove(event) {
        if (!this.touchStartY) return;
        
        const deltaY = event.touches[0].clientY - this.touchStartY;
        const deltaTime = Date.now() - this.touchStartTime;
        
        // Only prevent default if it's a quick horizontal swipe
        if (Math.abs(deltaY) < 10 && deltaTime < 200) {
            event.preventDefault();
        }
    },

    handleTouchEnd() {
        this.touchStartY = null;
        this.touchStartTime = null;
    },

    handleSearch(e) {
        this.search = e.target.value;
        document.querySelectorAll('.skill-group').forEach(group => {
            let hasVisible = false;
            group.querySelectorAll('label').forEach(label => {
                const name = label.querySelector('span').textContent;
                const visible = !this.search || name.toLowerCase().includes(this.search.toLowerCase());
                label.style.display = visible ? '' : 'none';
                if (visible) hasVisible = true;
            });
            group.style.display = hasVisible ? '' : 'none';
        });
    },

    startLetterDrag(e) {
        this.lastTouchY = e.touches[0].clientY;
        this.isScrolling = false;
    },

    handleLetterDrag(e) {
        if (!this.lastTouchY) return;
        
        const touch = e.touches[0];
        const nav = e.currentTarget;
        const rect = nav.getBoundingClientRect();
        const percentage = (touch.clientY - rect.top) / rect.height;
        const index = Math.floor(percentage * nav.children.length);
        const button = nav.children[index];
        
        if (button && !this.isScrolling) {
            e.preventDefault();
            const letter = button.textContent.trim();
            this.previewLetter(letter);
            this.jumpToLetter(letter);
        }
    },

    endLetterDrag() {
        this.lastTouchY = null;
        setTimeout(() => this.hideLetterPreview(), 1000);
    },

    previewLetter(letter) {
        this.currentPreviewLetter = letter;
    },

    hideLetterPreview() {
        this.currentPreviewLetter = null;
    },

    handleScroll(e) {
        if (!this.isScrolling) {
            this.isScrolling = true;
            
            const container = e.target;
            const groups = container.querySelectorAll('.skill-group');
            let mostVisible = null;
            let maxVisibleHeight = 0;
            
            groups.forEach(group => {
                const rect = group.getBoundingClientRect();
                const visibleHeight = Math.min(rect.bottom, window.innerHeight) - 
                                    Math.max(rect.top, 0);
                
                if (visibleHeight > maxVisibleHeight) {
                    maxVisibleHeight = visibleHeight;
                    mostVisible = group;
                }
            });
            
            if (mostVisible) {
                const letter = mostVisible.dataset.letter;
                this.currentLetter = letter;
                document.querySelectorAll('.skill-group').forEach(g => {
                    g.classList.toggle('active', g === mostVisible);
                });
            }
            
            setTimeout(() => this.isScrolling = false, 100);
        }
    },

    handleMouseMove(event) {
        if (!this.isScrolling) {
            this.lastMouseX = event.clientX;
            this.lastMouseY = event.clientY;
            
            const nav = event.currentTarget;
            const rect = nav.getBoundingClientRect();
            const percentage = (event.clientY - rect.top) / rect.height;
            const index = Math.floor(percentage * (nav.children.length - 1));
            const button = nav.children[index];
            
            if (button) {
                const letter = button.textContent.trim();
                this.previewLetter(letter);
            }
        }
    },

    get previewPosition() {
        if (!this.currentPreviewLetter) return '';
        // Use the last known mouse position to prevent resetting
        return `transform: translate(${this.lastMouseX + 20}px, ${this.lastMouseY}px) translate(-50%, -50%);`;
    }
}" 
     @keydown.escape.window="cancel()"
     @open-skills-modal.window="handleSkillsUpdate($event)">
    
    <!-- Backdrop -->
    <div x-show="open" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 bg-black/25 backdrop-blur-sm" 
         aria-hidden="true"></div>

    <!-- Modal -->
    <div x-show="open" 
         class="modal modal-open">
        <div class="relative max-h-[90vh] w-11/12 max-w-5xl mx-auto rounded-2xl overflow-hidden flex flex-col bg-base-100/50 backdrop-blur-md shadow-xl">
            <!-- Header with search -->
            <div class="sticky top-0 z-30 px-6 py-4 bg-base-100/50 backdrop-blur-md border-b border-base-200/30">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <iconify-icon icon="heroicons:academic-cap" class="text-primary text-2xl"></iconify-icon>
                        Manage Skills
                    </h3>
                    <div class="flex-1 flex items-center gap-4">
                        <div class="relative flex-1 max-w-md">
                            <input type="text" 
                                   x-model="search"
                                   @input="handleSearch($event)"
                                   placeholder="Search skills..."
                                   class="input input-bordered w-full pl-10">
                            <iconify-icon icon="heroicons:magnifying-glass" 
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-xl text-base-content/50">
                            </iconify-icon>
                        </div>
                        <div class="badge badge-primary badge-lg gap-2">
                            <span x-text="selectedSkills.length"></span>
                            <span>Selected</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main content -->
            <div class="flex-1 overflow-y-auto bg-base-100/50 overscroll-contain scroll-smooth">
                <div class="flex h-full">
                    <!-- Letter navigation with touch preview -->
                    <div class="quick-letters-nav" 
                         @touchstart="startLetterDrag" 
                         @mousemove="handleMouseMove($event)"
                         @touchmove="handleLetterDrag" 
                         @touchend="endLetterDrag">
                        {% for group in skill_icons %}
                        <button @click="jumpToLetter('{{ group.letter }}')"
                                @mouseenter="previewLetter('{{ group.letter }}')"
                                @mouseleave="hideLetterPreview()"
                                class="letter-nav-button"
                                :class="{'active': currentLetter === '{{ group.letter }}'}">
                            {{ group.letter }}
                        </button>
                        {% endfor %}
                        <!-- Letter preview bubble -->
                        <div class="letter-bubble" 
                             :style="previewPosition"
                             :class="{'visible': currentPreviewLetter}"
                             x-text="currentPreviewLetter">
                        </div>
                    </div>

                    <!-- Skills grid -->
                    <div class="flex-1 overflow-y-auto px-6 scroll-smooth" 
                         x-ref="skillsContainer"
                         @scroll.throttle.50ms="handleScroll">
                        {% for group in skill_icons %}
                        <div class="skill-group" data-letter="{{ group.letter }}">
                            <div class="sticky top-0 py-3 mb-4">
                                <div class="flex items-center gap-3">
                                    <span class="text-4xl font-black text-primary">{{ group.letter }}</span>
                                    <div class="h-px flex-1 bg-gradient-to-r from-primary/20 to-transparent"></div>
                                </div>
                            </div>
                            <div class="grid gap-2 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                                {% for skill in group.skills %}
                                <button type="button"
                                        class="skill-card"
                                        :class="{'selected': isSelected('{{ skill.name }}')}"
                                        @click="handleQuickSelect($event, JSON.parse('{{ skill|json|escapejs }}'))">
                                    <div class="icon-wrapper">
                                        <iconify-icon icon="{{ skill.icon }}" width="24" height="24"></iconify-icon>
                                    </div>
                                    <span class="skill-name">{{ skill.name }}</span>
                                    <div class="check-indicator">
                                        <iconify-icon icon="heroicons:check-circle" class="text-xl"></iconify-icon>
                                    </div>
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="sticky bottom-0 z-30 px-6 py-4 bg-base-100/50 backdrop-blur-md border-t border-base-200/30">
                <div class="flex items-center justify-between">
                    <kbd class="hidden sm:inline-flex kbd kbd-sm gap-2 items-center bg-base-200">
                        <span class="font-sans font-medium">Shift</span> + Click for multi-select
                    </kbd>
                    <div class="flex gap-2">
                        <button @click="cancel()" class="btn">Cancel</button>
                        <button @click="save()" class="btn btn-primary gap-2">
                            Apply Changes
                            <span class="badge badge-sm" x-text="selectedSkills.length"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop" @click="cancel()"></div>
    </div>
</div>
