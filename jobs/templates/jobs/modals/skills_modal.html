{% load job_tags %}

<div x-data="{
    open: false,
    search: '',
    selectedSkills: [],
    currentLetter: null,
    touchStartY: null,
    touchStartTime: null,
    
    init() {
        this.$watch('open', value => {
            if (value) {
                this.search = '';
                this.selectedSkills = window.skillSelect?.items.map(name => ({
                    name: name,
                    ...window.skillSelect.options[name]
                })) || [];
            } else {
                window.skillsManager?.resetModalState();
            }
        });
    },

    handleSkillsUpdate(e) {
        if (e?.detail?.selectedSkills) {
            this.selectedSkills = e.detail.selectedSkills;
        }
        this.open = true;
    },

    toggleSkill(skill) {
        const index = this.selectedSkills.findIndex(s => s.name === skill.name);
        if (index === -1) {
            this.selectedSkills.push(skill);
        } else {
            this.selectedSkills.splice(index, 1);
        }
    },

    cancel() {
        this.open = false;
        this.search = '';
        // Restore original selections
        if (window.skillSelect) {
            this.selectedSkills = window.skillSelect.items.map(name => ({
                name: name,
                ...window.skillSelect.options[name]
            }));
        }
    },

    save() {
        // Ensure we're sending the complete skill objects
        const skillsToUpdate = this.selectedSkills.map(skill => ({
            name: skill.name,
            icon: skill.icon,
            icon_dark: skill.icon_dark
        }));
        
        this.$dispatch('skills-updated', skillsToUpdate);
        this.cancel();
    },

    isSelected(skillName) {
        return this.selectedSkills.some(s => s.name === skillName);
    },

    jumpToLetter(letter) {
        const group = this.$refs.skillsContainer.querySelector(`[data-letter='${letter}']`);
        if (group) {
            this.currentLetter = letter;
            group.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    },

    handleQuickSelect(event, skill) {
        if (event.shiftKey && this.lastSelected) {
            // Get all skills between last selected and current
            const skills = Array.from(this.$refs.skillsContainer.querySelectorAll('[data-skill]'));
            const start = skills.findIndex(s => s.dataset.name === this.lastSelected.name);
            const end = skills.findIndex(s => s.dataset.name === skill.name);
            const range = skills.slice(Math.min(start, end), Math.max(start, end) + 1);
            
            range.forEach(skillEl => {
                const skillData = JSON.parse(skillEl.dataset.skill);
                if (!this.isSelected(skillData.name)) {
                    this.toggleSkill(skillData);
                }
            });
        } else {
            this.toggleSkill(skill);
            this.lastSelected = skill;
        }
    },

    handleTouchStart(event) {
        this.touchStartY = event.touches[0].clientY;
        this.touchStartTime = Date.now();
    },

    handleTouchMove(event) {
        if (!this.touchStartY) return;
        
        const deltaY = event.touches[0].clientY - this.touchStartY;
        const deltaTime = Date.now() - this.touchStartTime;
        
        // Only prevent default if it's a quick horizontal swipe
        if (Math.abs(deltaY) < 10 && deltaTime < 200) {
            event.preventDefault();
        }
    },

    handleTouchEnd() {
        this.touchStartY = null;
        this.touchStartTime = null;
    },

    handleSearch(e) {
        this.search = e.target.value;
        document.querySelectorAll('.skill-group').forEach(group => {
            let hasVisible = false;
            group.querySelectorAll('label').forEach(label => {
                const name = label.querySelector('span').textContent;
                const visible = !this.search || name.toLowerCase().includes(this.search.toLowerCase());
                label.style.display = visible ? '' : 'none';
                if (visible) hasVisible = true;
            });
            group.style.display = hasVisible ? '' : 'none';
        });
    }
}" 
     @keydown.escape.window="cancel()"
     @open-skills-modal.window="handleSkillsUpdate($event)">
    
    <!-- Backdrop -->
    <div x-show="open" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 bg-black/25 backdrop-blur-sm" 
         aria-hidden="true"></div>

    <!-- Modal -->
    <div x-show="open" 
         class="modal modal-open"
         x-transition>
        <div class="modal-box">
            <div class="modal-header">
                <h3 class="text-lg font-bold">Manage Skills</h3>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-base-content/70" x-text="selectedSkills.length + ' selected'"></span>
                    <input type="text" 
                           x-model="search"
                           placeholder="Search skills..."
                           class="input input-bordered input-sm w-64">
                </div>
            </div>
            
            <div class="modal-content">
                <div class="flex gap-4">
                    <!-- Quick letter navigation -->
                    <div class="quick-letters-nav">
                        {% for group in skill_icons %}
                        <button @click="jumpToLetter('{{ group.letter }}')"
                                class="letter-nav-button"
                                :class="{'active': currentLetter === '{{ group.letter }}'}">
                            {{ group.letter }}
                        </button>
                        {% endfor %}
                    </div>

                    <!-- Skills grid -->
                    <div class="flex-1" x-ref="skillsContainer">
                        {% for group in skill_icons %}
                        <div class="skill-group" data-letter="{{ group.letter }}">
                            <h4 class="skill-group-header">{{ group.letter }}</h4>
                            <div class="skill-grid">
                                {% for skill in group.skills %}
                                <button type="button"
                                        class="skill-button"
                                        :class="{'selected': isSelected('{{ skill.name }}')}"
                                        @click="handleQuickSelect($event, JSON.parse('{{ skill|json|escapejs }}'))">
                                    <div class="w-8 h-8 flex items-center justify-center bg-base-200 rounded-lg shrink-0">
                                        <iconify-icon icon="{{ skill.icon }}" class="text-xl"></iconify-icon>
                                    </div>
                                    <span class="text-sm font-medium">{{ skill.name }}</span>
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="modal-action">
                <div class="text-sm text-base-content/70">
                    Press <kbd class="kbd kbd-sm">Shift</kbd> + Click to select multiple
                </div>
                <div class="flex gap-2">
                    <button @click="cancel()" class="btn btn-ghost">Cancel</button>
                    <button @click="save()" class="btn btn-primary">
                        Apply <span x-text="'(' + selectedSkills.length + ')'"></span>
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-backdrop" @click="cancel()"></div>
    </div>
</div>

<style>
/* Add CSS to improve touch handling */
.modal-box {
    overscroll-behavior: contain;
}

.overflow-y-auto {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
}

@media (hover: none) {
    /* Touch device optimizations */
    .letter-nav-button {
        min-height: 2.5rem; /* Larger touch target */
        touch-action: manipulation;
    }
}
</style>
