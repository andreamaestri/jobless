{% load job_tags %}

<div x-data="{
    selectedSkills: [],
    open: false,
    search: '',
    currentLetter: null,
    currentPreviewLetter: null,
    lastSelected: null,
    touchStartY: null,
    touchStartTime: null,
    lastTouchY: null,
    isScrolling: false,
    mouseX: 0,
    mouseY: 0,
    lastMouseX: 0,
    lastMouseY: 0,
    init() {
        window.skillsManager?.resetModalState();
    },

    handleSkillsUpdate(e) {
        if (e?.detail?.selectedSkills) {
            this.selectedSkills = e.detail.selectedSkills;
        }
        this.open = true;
    },

    toggleSkill(skill) {
        const index = this.selectedSkills.findIndex(s => s.name === skill.name);
        if (index === -1) {
            this.selectedSkills.push(skill);
        } else {
            this.selectedSkills.splice(index, 1);
        }
    },

    cancel() {
        this.open = false;
        this.search = '';
        // Restore original selections
        if (window.skillSelect) {
            this.selectedSkills = window.skillSelect.items.map(name => ({
                name: name,
                ...window.skillSelect.options[name]
            }));
        }
    },

    save() {
        // Ensure we're sending the complete skill objects
        const skillsToUpdate = this.selectedSkills.map(skill => ({
            name: skill.name,
            icon: skill.icon,
            icon_dark: skill.icon_dark
        }));
        
        this.$dispatch('skills-updated', skillsToUpdate);
        this.open = false;
        this.search = '';
    },

    isSelected(skillName) {
        return this.selectedSkills.some(s => s.name === skillName);
    },

    jumpToLetter(letter) {
        const group = this.$refs.skillsContainer.querySelector(`[data-letter='${letter}']`);
        if (group) {
            this.currentLetter = letter;
            group.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    },

    handleQuickSelect(event, skill) {
        if (event.shiftKey && this.lastSelected) {
            // Get all skills between last selected and current
            const skills = Array.from(this.$refs.skillsContainer.querySelectorAll('[data-skill]'));
            const start = skills.findIndex(s => s.dataset.name === this.lastSelected.name);
            const end = skills.findIndex(s => s.dataset.name === skill.name);
            const range = skills.slice(Math.min(start, end), Math.max(start, end) + 1);
            
            range.forEach(skillEl => {
                const skillData = JSON.parse(skillEl.dataset.skill);
                if (!this.isSelected(skillData.name)) {
                    this.toggleSkill(skillData);
                }
            });
        } else {
            this.toggleSkill(skill);
            this.lastSelected = skill;
        }
    },

    handleTouchStart(event) {
        this.touchStartY = event.touches[0].clientY;
        this.touchStartTime = Date.now();
    },

    handleTouchMove(event) {
        if (!this.touchStartY) return;
        
        const deltaY = event.touches[0].clientY - this.touchStartY;
        const deltaTime = Date.now() - this.touchStartTime;
        
        // Only prevent default if it's a quick horizontal swipe
        if (Math.abs(deltaY) < 10 && deltaTime < 200) {
            event.preventDefault();
        }
    },

    handleTouchEnd() {
        this.touchStartY = null;
        this.touchStartTime = null;
    },

    handleSearch(e) {
        this.search = e.target.value;
        this.$refs.skillsContainer.querySelectorAll('.skill-group').forEach(group => {
            let hasVisible = false;
            group.querySelectorAll('.skill-card').forEach(card => {
                const name = card.querySelector('.skill-name').textContent;
                const visible = !this.search || name.toLowerCase().includes(this.search.toLowerCase());
                card.style.display = visible ? '' : 'none';
                if (visible) hasVisible = true;
            });
            group.style.display = hasVisible ? '' : 'none';
        });
    },

    startLetterDrag(e) {
        this.lastTouchY = e.touches[0].clientY;
        this.isScrolling = false;
    },

    handleLetterDrag(e) {
        if (!this.lastTouchY) return;
        
        const touch = e.touches[0];
        const nav = e.currentTarget;
        const rect = nav.getBoundingClientRect();
        const percentage = (touch.clientY - rect.top) / rect.height;
        const index = Math.floor(percentage * nav.children.length);
        const button = nav.children[index];
        
        if (button && !this.isScrolling) {
            e.preventDefault();
            const letter = button.textContent.trim();
            this.previewLetter(letter);
            this.jumpToLetter(letter);
        }
    },

    endLetterDrag() {
        this.lastTouchY = null;
        setTimeout(() => this.hideLetterPreview(), 1000);
    },

    previewLetter(letter) {
        this.currentPreviewLetter = letter;
    },

    hideLetterPreview() {
        this.currentPreviewLetter = null;
    },

    handleScroll(e) {
        if (!this.isScrolling) {
            this.isScrolling = true;
            
            const container = e.target;
            const groups = container.querySelectorAll('.skill-group');
            let mostVisible = null;
            let maxVisibleHeight = 0;
            
            groups.forEach(group => {
                const rect = group.getBoundingClientRect();
                const visibleHeight = Math.min(rect.bottom, window.innerHeight) - 
                                    Math.max(rect.top, 0);
                
                if (visibleHeight > maxVisibleHeight) {
                    maxVisibleHeight = visibleHeight;
                    mostVisible = group;
                }
            });
            
            if (mostVisible) {
                const letter = mostVisible.dataset.letter;
                this.currentLetter = letter;
                document.querySelectorAll('.skill-group').forEach(g => {
                    g.classList.toggle('active', g === mostVisible);
                });
            }
            
            setTimeout(() => this.isScrolling = false, 100);
        }
    },

    letterNavigationActive: false,
    letterHoverTimeout: null,

    startLetterNavigation() {
        this.letterNavigationActive = true;
    },

    stopLetterNavigation() {
        this.letterNavigationActive = false;
        if (this.letterHoverTimeout) {
            clearTimeout(this.letterHoverTimeout);
            this.letterHoverTimeout = null;
        }
    },

    handleMouseMove(event) {
        if (!this.isScrolling && this.letterNavigationActive) {
            this.mouseX = this.lastMouseX = event.clientX;
            this.mouseY = this.lastMouseY = event.clientY;
            
            const nav = event.currentTarget;
            const rect = nav.getBoundingClientRect();
            
            // Don't trigger near the bottom where the Apply button is
            const bottomThreshold = rect.bottom - 60;
            if (event.clientY > bottomThreshold) {
                return;
            }
            
            const letters = nav.querySelectorAll('button');
            const letterHeight = rect.height / letters.length;
            const relativeY = event.clientY - rect.top;
            const index = Math.min(
                Math.floor(relativeY / letterHeight),
                letters.length - 1
            );
            
            if (index >= 0 && index < letters.length) {
                const letter = letters[index].textContent.trim();
                this.previewLetter(letter);
                
                // Clear any existing timeout
                if (this.letterHoverTimeout) {
                    clearTimeout(this.letterHoverTimeout);
                }
                
                // Set new timeout for jumping to letter
                this.letterHoverTimeout = setTimeout(() => {
                    if (this.letterNavigationActive) {
                        this.jumpToLetter(letter);
                    }
                }, 150); // 150ms delay before jumping
            }
        }
    },

    get previewPosition() {
        if (!this.currentPreviewLetter) {
            // Keep last position but hide it
            return `transform: translate(${this.lastMouseX + 12}px, ${this.lastMouseY}px) translate(-50%, -50%); opacity: 0;`;
        }
        return `transform: translate(${this.lastMouseX + 12}px, ${this.lastMouseY}px) translate(-50%, -50%); opacity: 1;`;
    }
}" 
     @keydown.escape.window="cancel()"
     @open-skills-modal.window="handleSkillsUpdate($event)">
    
    <!-- Backdrop -->
    <div x-show="open" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 bg-black/25 backdrop-blur-sm" 
         aria-hidden="true"></div>

    <!-- Modal -->
    <div x-show="open" 
         class="modal modal-open">
        <div class="relative w-11/12 max-w-5xl mx-auto rounded-2xl overflow-hidden bg-base-100/50 backdrop-blur-md shadow-xl flex flex-col h-[90vh]">
            <!-- Header with search -->
            <div class="sticky top-0 z-30 px-6 py-4 bg-base-100/50 backdrop-blur-md border-b border-base-200/30">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <iconify-icon icon="heroicons:academic-cap" class="text-primary text-2xl"></iconify-icon>
                        Manage Skills
                    </h3>
                    <div class="flex-1 flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-1 max-w-md">
                            <input type="text" 
                                   x-model="search"
                                   @input="handleSearch($event)"
                                   placeholder="Search skills..."
                                   class="input input-bordered w-full pl-10">
                            <iconify-icon icon="heroicons:magnifying-glass" 
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-xl text-base-content/50">
                            </iconify-icon>
                        </div>
                        <div class="badge badge-primary badge-lg gap-2">
                            <span x-text="selectedSkills.length"></span>
                            <span>Selected</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main content -->
            <div class="flex-1 min-h-0 bg-base-100/50 overscroll-contain">
                <div class="flex h-full overflow-hidden">
                    <!-- Letter navigation -->
                    <nav class="w-8 flex flex-col gap-px p-1 sticky top-4 z-40 opacity-75 hover:opacity-100 transition-opacity duration-200 mr-2 h-[calc(100vh-12rem)] bg-base-100 backdrop-blur border-r border-base-200 sm:flex-row sm:fixed sm:bottom-16 sm:top-auto sm:left-0 sm:right-0 sm:h-auto sm:w-full sm:flex-nowrap sm:justify-center sm:border-r-0 sm:border-t"
                         @touchstart="startLetterDrag"
                         @touchmove.passive="handleLetterDrag"
                         @touchend="endLetterDrag"
                         @mousemove.throttle.100ms="handleMouseMove($event)"
                         @mouseleave="hideLetterPreview()"
                         @mouseenter="startLetterNavigation"
                         @mouseleave="stopLetterNavigation">
                        {% for group in skill_icons %}
                        <button @click="jumpToLetter('{{ group.letter }}')"
                                @mouseenter="previewLetter('{{ group.letter }}')"
                                @mouseleave="hideLetterPreview()"
                                class="w-6 h-6 flex items-center justify-center text-xs font-medium text-base-content/60 hover:text-primary-content hover:bg-primary rounded transition-colors sm:w-8 sm:h-8"
                                :class="{'text-primary font-semibold bg-primary/10': currentLetter === '{{ group.letter }}'}">
                            {{ group.letter }}
                        </button>
                        {% endfor %}
                        
                        <!-- Letter preview bubble -->
                        <div class="fixed z-50 pointer-events-none opacity-0 transition-opacity duration-150 hidden sm:block" 
                             :style="previewPosition"
                             :class="{'opacity-100': currentPreviewLetter}">
                            <div class="bg-primary text-primary-content px-6 py-4 rounded-xl shadow-lg">
                                <span x-text="currentPreviewLetter" class="text-4xl font-black"></span>
                            </div>
                            <div class="absolute -left-1.5 top-1/2 -translate-y-1/2 border-8 border-transparent border-r-primary"></div>
                        </div>
                    </nav>

                    <!-- Skills grid -->
                    <div class="flex-1 overflow-y-auto px-6 scroll-smooth" 
                         x-ref="skillsContainer"
                         @scroll.throttle.50ms="handleScroll">
                        {% for group in skill_icons %}
                        <div class="skill-group" data-letter="{{ group.letter }}">
                            <div class="sticky bg-primary rounded-xl top-0 p-3 mb-4 z-30 border-b border-base-200/30">
                                <div class="flex items-center gap-3">
                                    <span class="text-4xl font-black text-primary-content">{{ group.letter }}</span>
                                    <div class="h-px flex-1 bg-gradient-to-r from-base-300 to-transparent"></div>
                                </div>
                            </div>
                            <div class="grid gap-2 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
                                {% for skill in group.skills %}
                                <button type="button"
                                        class="skill-card"
                                        data-skill="{{ skill|json|escapejs }}"
                                        :class="{'selected': isSelected('{{ skill.name }}')}"
                                        @click="handleQuickSelect($event, JSON.parse('{{ skill|json|escapejs }}'))">
                                    <div class="icon-wrapper">
                                        <iconify-icon icon="{{ skill.icon_dark|default:skill.icon }}" 
                                                      width="45" 
                                                      height="45"
                                                      ></iconify-icon>
                                    </div>
                                    <span class="skill-name p-2">{{ skill.name }}</span>
                                    <div class="check-indicator">
                                        <iconify-icon icon="heroicons:check-circle" class="text-xl"></iconify-icon>
                                    </div>
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="sticky bottom-0 z-30 px-4 sm:px-6 py-4 bg-base-100/95 backdrop-blur-md border-t border-base-200/30">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-2">
                        <iconify-icon icon="heroicons:information-circle" class="text-base-content/60 text-xl"></iconify-icon>
                        <span class="text-sm text-base-content/60">Selected skills: <span class="font-semibold text-primary" x-text="selectedSkills.length"></span></span>
                    </div>
                    <div class="flex gap-3 w-full sm:w-auto">
                        <button @click="cancel()" 
                                class="btn btn-ghost flex-1 sm:flex-none hover:bg-error/10 hover:text-error">
                            Cancel
                        </button>
                        <button @click="save()" 
                                class="btn btn-primary flex-1 sm:flex-none gap-2">
                            Apply Changes
                            <span class="badge badge-primary-content badge-sm" x-text="selectedSkills.length"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop" @click="cancel()"></div>
    </div>
</div>
