<div x-data="skillSelector" class="relative" x-init="initSkills('{{ widget.value|default:"" }}')">
    <!-- Hidden input for form submission -->
    <input type="hidden" name="{{ widget.name }}" x-ref="hiddenInput" :value="selectedSkills.join(',')">
    
    <!-- Search and Tag Display Area -->
    <div class="relative flex flex-col gap-2 p-2 bg-base-100 rounded-xl border border-base-300 focus-within:border-primary focus-within:ring-1 focus-within:ring-primary">
        <!-- Selected Tags Display -->
        <div class="flex flex-wrap gap-2">
            <template x-for="skill in selectedSkills" :key="skill">
                <span class="inline-flex items-center gap-1 px-2 py-1 bg-primary/10 text-primary rounded-lg text-sm">
                    <iconify-icon :icon="getSkillIcon(skill)" class="mr-1"></iconify-icon>
                    <span x-text="skill"></span>
                    <button type="button" @click="removeSkill(skill)" class="hover:text-error">
                        <iconify-icon icon="octicon:x-16"></iconify-icon>
                    </button>
                </span>
            </template>
        </div>

        <!-- Search Input -->
        <div class="flex items-center gap-2">
            <div class="relative flex-1">
                <input type="text"
                    x-model="searchQuery"
                    @focus="showSuggestions = true"
                    @keydown.enter.prevent="handleEnter"
                    @keydown.down.prevent="navigateSuggestion(1)"
                    @keydown.up.prevent="navigateSuggestion(-1)"
                    @keydown.escape="closeSuggestions"
                    placeholder="Search skills..."
                    class="w-full border-0 bg-transparent focus:ring-0 text-sm placeholder:text-base-content/50">
            </div>
            <button type="button" 
                    @click="toggleSkillBrowser"
                    class="btn btn-ghost btn-sm tooltip tooltip-left"
                    data-tip="Browse all skills">
                <iconify-icon icon="octicon:list-unordered-16"></iconify-icon>
            </button>
        </div>
    </div>

    <!-- Quick Suggestions Dropdown -->
    <div x-show="showSuggestions && filteredSkills.length > 0"
         x-transition
         @click.away="closeSuggestions"
         class="absolute z-50 w-full mt-1 bg-base-100 rounded-lg shadow-lg border border-base-300 max-h-48 overflow-y-auto custom-scrollbar">
        <div class="p-1">
            <template x-for="(skill, index) in filteredSkills" :key="skill.name">
                <button type="button"
                        @click="addSkill(skill.name)"
                        class="w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-base-200 flex items-center gap-2"
                        :class="{ 'bg-base-200': selectedIndex === index }">
                    <iconify-icon :icon="skill.icon"></iconify-icon>
                    <span x-text="skill.name"></span>
                </button>
            </template>
        </div>
    </div>

    <!-- Skill Browser Modal -->
    <dialog id="skillBrowser" class="modal">
        <div class="modal-box max-w-3xl">
            <h3 class="font-bold text-lg mb-4">Browse Skills</h3>
            
            <!-- Search and Categories -->
            <div class="flex gap-4 mb-4">
                <div class="form-control flex-1">
                    <input type="text" 
                           x-model="browserSearch" 
                           placeholder="Filter skills..."
                           class="input input-bordered w-full">
                </div>
                <div class="form-control w-48">
                    <select x-model="selectedCategory" class="select select-bordered">
                        <option value="">All Categories</option>
                        <template x-for="cat in categories" :key="cat">
                            <option :value="cat" x-text="cat"></option>
                        </template>
                    </select>
                </div>
            </div>

            <!-- Skills Grid -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-[400px] overflow-y-auto custom-scrollbar p-2">
                <template x-for="skill in filteredBrowserSkills" :key="skill.name">
                    <button type="button"
                            @click="toggleSkill(skill.name)"
                            :class="{ 'bg-primary/10 text-primary': isSelected(skill.name) }"
                            class="flex items-center gap-2 p-2 rounded-lg hover:bg-base-200 text-sm">
                        <iconify-icon :icon="skill.icon"></iconify-icon>
                        <span x-text="skill.name"></span>
                    </button>
                </template>
            </div>

            <!-- Modal Actions -->
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Close</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('skillSelector', () => ({
        selectedSkills: [],
        searchQuery: '',
        showSuggestions: false,
        selectedIndex: -1,
        browserSearch: '',
        selectedCategory: '',
        skillsList: SKILL_ICONS.map(([icon, name]) => ({ icon, name })),
        categories: [...new Set(SKILL_ICONS.map(([icon]) => icon.split(':')[0]))],

        initSkills(initialValue) {
            if (initialValue) {
                this.selectedSkills = initialValue.split(',').map(s => s.trim());
            }
        },

        get filteredSkills() {
            return this.skillsList
                .filter(skill => !this.selectedSkills.includes(skill.name))
                .filter(skill => skill.name.toLowerCase().includes(this.searchQuery.toLowerCase()))
                .slice(0, 10);
        },

        get filteredBrowserSkills() {
            return this.skillsList
                .filter(skill => {
                    const matchesSearch = skill.name.toLowerCase().includes(this.browserSearch.toLowerCase());
                    const matchesCategory = !this.selectedCategory || skill.icon.startsWith(this.selectedCategory + ':');
                    return matchesSearch && matchesCategory;
                });
        },

        toggleSkillBrowser() {
            document.getElementById('skillBrowser').showModal();
        },

        addSkill(skill) {
            if (!this.selectedSkills.includes(skill)) {
                this.selectedSkills.push(skill);
                this.updateHiddenInput();
            }
            this.searchQuery = '';
            this.showSuggestions = false;
        },

        removeSkill(skill) {
            this.selectedSkills = this.selectedSkills.filter(s => s !== skill);
            this.updateHiddenInput();
        },

        toggleSkill(skill) {
            if (this.isSelected(skill)) {
                this.removeSkill(skill);
            } else {
                this.addSkill(skill);
            }
        },

        isSelected(skill) {
            return this.selectedSkills.includes(skill);
        },

        getSkillIcon(skillName) {
            return this.skillsList.find(s => s.name === skillName)?.icon || 'octicon:code-16';
        },

        updateHiddenInput() {
            this.$refs.hiddenInput.value = this.selectedSkills.join(',');
        },

        handleEnter() {
            if (this.selectedIndex >= 0 && this.filteredSkills[this.selectedIndex]) {
                this.addSkill(this.filteredSkills[this.selectedIndex].name);
            } else if (this.searchQuery) {
                this.addSkill(this.searchQuery);
            }
        },

        navigateSuggestion(direction) {
            if (!this.showSuggestions) return;
            
            const maxIndex = this.filteredSkills.length - 1;
            this.selectedIndex = Math.max(-1, Math.min(maxIndex,
                this.selectedIndex + direction));
        },

        closeSuggestions() {
            this.showSuggestions = false;
            this.selectedIndex = -1;
        }
    }));
});
</script>
