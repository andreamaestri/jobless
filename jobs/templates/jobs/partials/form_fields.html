{% autoescape off %}
{% if parsed %}
<div class="alert alert-success">
    <iconify-icon icon="heroicons:check-circle"></iconify-icon>
    <span>Job details extracted successfully!</span>
</div>
<script>
    // Update form fields with parsed data
    const fields = {{ parsed|safe }};
    Object.entries(fields).forEach(([field, value]) => {
        const input = document.querySelector(`[name="${field}"]`);
        if (input) {
            input.value = value;
            input.setAttribute('data-ai-filled', 'true');
        }
    });
</script>
{% endif %}
{% if parsed %}
<div id="parse-results">
    <div class="alert alert-success mb-4">
        <iconify-icon icon="heroicons:check-circle"></iconify-icon>
        <span>Job details extracted successfully!</span>
    </div>
    
    <script>
        (function() {
            // Helper function to safely set form field values
            function setFieldValue(fieldId, value) {
                const field = document.getElementById(fieldId);
                if (field && !field.value) {
                    field.value = value;
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }

            // Set form fields
            setFieldValue('id_title', '{{ parsed.title|escapejs }}');
            setFieldValue('id_company', '{{ parsed.company|escapejs }}');
            setFieldValue('id_location', '{{ parsed.location|escapejs }}');
            setFieldValue('id_salary_range', '{{ parsed.salary_range|escapejs }}');
            
            // Handle description with proper line breaks
            const description = `{{ parsed.description|escapejs }}`.replace(/\\n/g, '\n');
            setFieldValue('id_description', description);
            
            // Update character counter
            const charCounter = document.getElementById('char-counter');
            const descField = document.getElementById('id_description');
            if (charCounter && descField) {
                const descLength = descField.value.length;
                charCounter.textContent = `${descLength}/4000`;
            }
        })();
    </script>
</div>
{% else %}
<div class="alert alert-error mt-4">
    <iconify-icon icon="heroicons:x-circle"></iconify-icon>
    <span>Could not parse job description - please check the text and try again</span>
</div>
{% endif %}
{% endautoescape %}
