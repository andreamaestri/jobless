{% extends "base.html" %}
{% load static %}
{% load job_tags %}

{% block extra_css %}
{{ block.super }}
<link href="{% static 'css/tom-select.css' %}" rel="stylesheet">
<link href="{% static 'css/letter-bubble.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block content %}
<div class="min-h-screen flex flex-col page-transition-wrapper">
    <div class="flex-1 overflow-y-auto pb-20 page-enter">
        <div class="p-4 sm:p-6 md:p-8 lg:py-12 lg:px-8">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-base-content">Add New Job</h1>
                        <p class="text-base-content/70 mt-2">Track and manage your job application</p>
                    </div>
                </div>

                <div class="bg-base-100 shadow-xl rounded-2xl relative overflow-hidden">
                    <form method="POST" 
                          id="job-form"
                          action="{% url 'jobs:add' %}"
                          enctype="multipart/form-data"
                          data-debug="true">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="p-4 mb-4 text-sm text-error-content bg-error rounded-lg">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <div class="divide-y divide-base-200">
                            <!-- AI Paste Section -->
                            <div class="p-8 form-section bg-gradient-to-br from-primary/5 to-transparent" style="--delay: 0">
                                <div class="flex items-center gap-2 mb-6">
                                    <iconify-icon icon="heroicons:sparkles" class="text-2xl text-primary"></iconify-icon>
                                    <h2 class="text-lg font-semibold text-base-content">Quick Fill with AI</h2>
                                </div>
                                <div class="space-y-4 relative">
                                    <div id="parse-form" class="parse-form">
                                        <div>
                                            <label for="paste" class="block text-sm font-medium text-base-content mb-2">
                                                Paste Job Description
                                                <span class="ml-1 text-xs text-base-content/60">(AI will extract details)</span>
                                            </label>
                                            <textarea id="paste" 
                                                      name="paste"
                                                      class="textarea textarea-bordered w-full min-h-[120px]"
                                                      placeholder="Paste the job description here..."></textarea>
                                        </div>
                                        <div class="flex justify-end mt-4">
                                            <button type="button" 
                                                    id="parse-button"
                                                    class="btn btn-primary btn-sm gap-2">
                                                <span class="loading loading-spinner loading-sm hidden"></span>
                                                <iconify-icon icon="heroicons:sparkles"></iconify-icon>
                                                <span>Process with AI</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Basic Information -->
                            <div class="p-8 form-section bg-base-100/50 transition-colors duration-200 hover:bg-base-100" style="--delay: 0">
                                <div class="flex items-center gap-2 mb-6">
                                    <iconify-icon icon="heroicons:information-circle" class="text-2xl text-primary"></iconify-icon>
                                    <h2 class="text-lg font-semibold text-base-content">Basic Information</h2>
                                </div>
                                <div class="grid grid-cols-1 gap-6">
                                    <!-- Title -->
                                    <div>
                                        <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                            Job Title <span class="text-error">*</span>
                                        </label>
                                        {{ form.title }}
                                        <p class="text-xs text-base-content/60 mt-1">Enter the official job title as listed in the posting</p>
                                        {% if form.title.errors %}
                                        <p class="text-error text-xs mt-1">{{ form.title.errors.0 }}</p>
                                        {% endif %}
                                    </div>

                                    <!-- Company and Location -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label for="{{ form.company.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                                Company <span class="text-error">*</span>
                                            </label>
                                            {{ form.company }}
                                            {% if form.company.errors %}
                                            <p class="text-error text-xs mt-1">{{ form.company.errors.0 }}</p>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                                Location <span class="text-error">*</span>
                                            </label>
                                            {{ form.location }}
                                            <p class="text-xs text-base-content/60 mt-1">City, State or Remote</p>
                                            {% if form.location.errors %}
                                            <p class="text-error text-xs mt-1">{{ form.location.errors.0 }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Details -->
                            <div class="p-8 form-section" style="--delay: 1">
                                <div class="flex items-center gap-2 mb-6">
                                    <iconify-icon icon="heroicons:clipboard-document-list" class="text-2xl text-primary"></iconify-icon>
                                    <h2 class="text-lg font-semibold text-base-content">Additional Details</h2>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- URL and Salary -->
                                    <div>
                                        <label for="{{ form.url.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                            Job URL
                                        </label>
                                        {{ form.url }}
                                        {% if form.url.errors %}
                                        <p class="text-error text-xs mt-1">{{ form.url.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label for="{{ form.salary_range.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                            Salary Range
                                        </label>
                                        {{ form.salary_range }}
                                        {% if form.salary_range.errors %}
                                        <p class="text-error text-xs mt-1">{{ form.salary_range.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Skills -->
                            <div class="p-8 form-section" style="--delay: 2">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center gap-2">
                                        <iconify-icon icon="heroicons:academic-cap" class="text-2xl text-primary"></iconify-icon>
                                        <h2 class="text-lg font-semibold text-base-content">Required Skills</h2>
                                    </div>
                                    <button type="button" 
                                            @click="$dispatch('open-skills-modal')"
                                            class="btn btn-ghost btn-sm gap-2">
                                        <iconify-icon icon="heroicons:squares-plus"></iconify-icon>
                                        Manage Skills
                                    </button>
                                </div>
                                
                                <div class="relative">
                                    <div class="form-control">
                                        <select id="skills-select" 
                                                multiple 
                                                placeholder="Search and select skills..."
                                                class="select select-bordered w-full min-h-[120px] focus:outline-none focus:ring-2 focus:ring-primary/20">
                                            <!-- Options will be populated via JavaScript -->
                                        </select>
                                    </div>
                                    <input type="hidden" name="skills" id="skills-input">
                                    <div class="flex items-center justify-between mt-2">
                                        <p class="text-xs text-base-content/60">
                                            Quick search and select skills, or use the Manage Skills button for more options
                                        </p>
                                        <span class="badge badge-sm" id="skills-count">0 selected</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Skills Modal -->
                            {% include "jobs/modals/skills_modal.html" %}

                            <!-- Status -->
                            <div class="p-8 form-section" style="--delay: 3">
                                <div class="flex items-center gap-2 mb-6">
                                    <iconify-icon icon="heroicons:flag" class="text-2xl text-primary"></iconify-icon>
                                    <h2 class="text-lg font-semibold text-base-content">Application Status</h2>
                                </div>
                                <div>
                                    <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Application Status
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.status.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="p-8 form-section" style="--delay: 4">
                                <div class="flex items-center gap-2 mb-6">
                                    <iconify-icon icon="heroicons:document-text" class="text-2xl text-primary"></iconify-icon>
                                    <h2 class="text-lg font-semibold text-base-content">Job Description</h2>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-base-content">
                                            Job Description
                                            <span class="ml-1 text-xs text-base-content/60">(Markdown supported)</span>
                                        </label>
                                        <span class="text-xs text-base-content/60" id="char-counter">0/4000</span>
                                    </div>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.description.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Form Actions (outside form but controls it) -->
<div class="fixed bottom-0 left-0 right-0 z-10 flex justify-between items-center px-8 py-6 bg-base-100 border-t border-base-200 shadow-lg backdrop-blur-sm bg-opacity-90 lg:left-[20rem] form-actions">
    <div class="text-sm text-base-content/60">
        <span class="text-error">*</span> Required fields
    </div>
    <div class="flex space-x-4">
        <a href="{% url 'jobs:list' %}"
           class="btn btn-ghost">
            Cancel
        </a>
        <button type="submit" 
                class="btn btn-primary gap-2 min-w-[120px]"
                form="job-form">
            <span class="loading loading-spinner loading-sm hidden"></span>
            <span class="button-text">Save Job</span>
            <iconify-icon icon="heroicons:arrow-right" class="text-lg"></iconify-icon>
        </button>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
{{ block.super }}

<!-- Load Iconify -->
<script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/iconify-icon@2.3.0/dist/iconify-icon.min.js"></script>

<!-- Icon mappings -->
<script>
    window.ICON_NAME_MAPPING = {{ icon_name_mapping|safe }};
    window.DARK_VARIANTS = {{ dark_variants|safe }};
</script>

<!-- Add defer attribute to ensure mappings are available -->
<script src="{% static 'js/skills-manager.js' %}" defer></script>
<script src="{% static 'js/skills-select.js' %}" defer></script>
<script src="{% static 'js/form-handler.js' %}" defer></script>
{% endblock extra_js %}
