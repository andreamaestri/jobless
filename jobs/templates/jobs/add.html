{% extends "base.html" %}
{% load static %}
{% load job_tags %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/css/tom-select.css" rel="stylesheet">
{{ block.super }}
{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col page-transition-wrapper">
    <div class="flex-1 overflow-y-auto pb-20 page-enter">
        <div class="p-4 sm:p-6 md:p-8 lg:py-12 lg:px-8">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-base-content">Add New Job</h1>
                        <p class="text-base-content/70 mt-2">Track and manage your job application</p>
                    </div>
                </div>

                <div class="bg-base-100 shadow-xl rounded-2xl relative">
                    <!-- AI Paste Section -->
                    <div class="p-8 form-section" style="--delay: 0">
                        <h2 class="text-lg font-semibold text-base-content mb-6">Quick Fill with AI</h2>
                        <div class="space-y-4">
                            <form id="parse-form" method="POST">
                                {% csrf_token %}
                                <div>
                                    <label for="paste" class="block text-sm font-medium text-base-content mb-2">
                                        Paste Job Description
                                        <span class="ml-1 text-xs text-base-content/60">(AI will extract details)</span>
                                    </label>
                                    <textarea id="paste" 
                                              name="paste"
                                              class="textarea textarea-bordered w-full min-h-[120px]"
                                              placeholder="Paste the job description here..."></textarea>
                                </div>
                                <div class="flex justify-end mt-4">
                                    <button type="submit" 
                                            class="btn btn-primary btn-sm gap-2">
                                        <span class="loading loading-spinner loading-sm hidden"></span>
                                        <iconify-icon icon="heroicons:sparkles"></iconify-icon>
                                        <span>Process with AI</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Main Form -->
                    <form method="POST" 
                          id="job-form" 
                          class="divide-y divide-base-200"
                          action="{% url 'jobs:add' %}"
                          enctype="multipart/form-data"
                          data-debug="true">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="p-4 mb-4 text-sm text-error-content bg-error rounded-lg">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- Basic Information -->
                        <div class="p-8 form-section" style="--delay: 0">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Basic Information</h2>
                            <div class="grid grid-cols-1 gap-6">
                                <!-- Title -->
                                <div>
                                    <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Job Title <span class="text-error">*</span>
                                    </label>
                                    {{ form.title }}
                                    <p class="text-xs text-base-content/60 mt-1">Enter the official job title as listed in the posting</p>
                                    {% if form.title.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.title.errors.0 }}</p>
                                    {% endif %}
                                </div>

                                <!-- Company and Location -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="{{ form.company.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                            Company <span class="text-error">*</span>
                                        </label>
                                        {{ form.company }}
                                        {% if form.company.errors %}
                                        <p class="text-error text-xs mt-1">{{ form.company.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                            Location <span class="text-error">*</span>
                                        </label>
                                        {{ form.location }}
                                        <p class="text-xs text-base-content/60 mt-1">City, State or Remote</p>
                                        {% if form.location.errors %}
                                        <p class="text-error text-xs mt-1">{{ form.location.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Details -->
                        <div class="p-8 form-section" style="--delay: 1">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Additional Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- URL and Salary -->
                                <div>
                                    <label for="{{ form.url.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Job URL
                                    </label>
                                    {{ form.url }}
                                    {% if form.url.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.url.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                <div>
                                    <label for="{{ form.salary_range.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Salary Range
                                    </label>
                                    {{ form.salary_range }}
                                    {% if form.salary_range.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.salary_range.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Skills -->
                        <div class="p-8 form-section" style="--delay: 2">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Required Skills</h2>
                            
                            <!-- Simplified skills container -->
                            <div class="skill-container" x-data @click="$dispatch('open-skills-modal')">
                                <div id="selected-skills" class="p-4 flex flex-wrap gap-2"></div>
                                <!-- Empty state CTA -->
                                <div class="empty-state flex items-center justify-center absolute inset-0">
                                    <div class="flex flex-col items-center gap-3 text-base-content/50">
                                        <iconify-icon icon="heroicons:plus-circle" class="text-4xl"></iconify-icon>
                                        <span class="text-sm font-medium">Add Skills</span>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" name="required_skills" id="skills-input">
                        </div>

                            <div x-data="skillsModal" @open-skills-modal.window="open = true">
                                {% include "jobs/modals/skills_modal.html" %}
                            </div>

                        <!-- Status -->
                        <div class="p-8 form-section" style="--delay: 3">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Application Status</h2>
                            <div>
                                <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                    Application Status
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                <p class="text-error text-xs mt-1">{{ form.status.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="p-8 form-section" style="--delay: 4">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Job Description</h2>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-base-content">
                                        Job Description
                                        <span class="ml-1 text-xs text-base-content/60">(Markdown supported)</span>
                                    </label>
                                    <span class="text-xs text-base-content/60" id="char-counter">0/4000</span>
                                </div>
                                {{ form.description }}
                                {% if form.description.errors %}
                                <p class="text-error text-xs mt-1">{{ form.description.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Form Actions (outside form but controls it) -->
<div class="fixed bottom-0 left-0 right-0 z-10 flex justify-between items-center p-8 bg-base-200 border-t border-base-300 lg:left-[20rem] form-actions">
    <div class="text-sm text-base-content/60">
        <span class="text-error">*</span> Required fields
    </div>
    <div class="flex space-x-4">
        <a href="{% url 'jobs:list' %}"
           class="btn btn-ghost">
            Cancel
        </a>
        <button type="submit" 
                class="btn btn-primary gap-2"
                form="job-form">
            <span class="loading loading-spinner loading-sm hidden"></span>
            <span class="button-text">Save Job</span>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
<script src="{% static 'js/skills-manager.js' %}"></script>
<script src="{% static 'js/job-form.js' %}"></script>
<script>
    console.log('Template script starting');
    window.addEventListener('load', function() {
        console.log('Window loaded');
    });
</script>
{% endblock %}
