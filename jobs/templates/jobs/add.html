{% extends "base.html" %}
{% load static %}
{% load job_tags %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/css/tom-select.css" rel="stylesheet">
{{ block.super }}
<style>
.htmx-indicator {
    display: none;
}
.htmx-request .htmx-indicator {
    display: inline-block;
}
.htmx-request.htmx-indicator {
    display: inline-block;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col page-transition-wrapper">
    <div class="flex-1 overflow-y-auto pb-20 page-enter">
        <div class="p-4 sm:p-6 md:p-8 lg:py-12 lg:px-8">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-base-content">Add New Job</h1>
                        <p class="text-base-content/70 mt-2">Track and manage your job application</p>
                    </div>
                </div>

                <div class="bg-base-100 shadow-xl rounded-2xl relative">
                    <!-- AI Paste Section - Move outside main form -->
                    <div class="p-8 form-section" style="--delay: 0">
                        <h2 class="text-lg font-semibold text-base-content mb-6">Quick Fill with AI</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="id_paste" class="block text-sm font-medium text-base-content mb-2">
                                    Paste Job Description
                                    <span class="ml-1 text-xs text-base-content/60">(AI will extract details)</span>
                                </label>
                                <textarea id="id_paste" 
                                          name="paste"
                                          class="textarea textarea-bordered w-full min-h-[120px]"
                                          placeholder="Paste the job description here..."></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="button" 
                                        class="btn btn-primary btn-sm gap-2"
                                        hx-post="{% url 'jobs:parse_description' %}"
                                        hx-include="#id_paste"
                                        hx-trigger="click"
                                        hx-target="#parse-results"
                                        hx-swap="none"
                                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                                    <span class="loading loading-spinner loading-sm htmx-indicator"></span>
                                    <iconify-icon icon="heroicons:sparkles"></iconify-icon>
                                    <span>Process with AI</span>
                                </button>
                            </div>
                            <div id="parse-results"></div>
                        </div>
                    </div>

                    <!-- Main Form -->
                    <form method="post" class="divide-y divide-base-200" id="job-form">
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <div class="p-8 form-section" style="--delay: 0">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Basic Information</h2>
                            <div class="grid grid-cols-1 gap-6">
                                <!-- Title -->
                                <div>
                                    <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Job Title <span class="text-error">*</span>
                                    </label>
                                    {{ form.title }}
                                    <p class="text-xs text-base-content/60 mt-1">Enter the official job title as listed in the posting</p>
                                    {% if form.title.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.title.errors.0 }}</p>
                                    {% endif %}
                                </div>

                                <!-- Company and Location -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="{{ form.company.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                            Company <span class="text-error">*</span>
                                        </label>
                                        {{ form.company }}
                                        {% if form.company.errors %}
                                        <p class="text-error text-xs mt-1">{{ form.company.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                            Location <span class="text-error">*</span>
                                        </label>
                                        {{ form.location }}
                                        <p class="text-xs text-base-content/60 mt-1">City, State or Remote</p>
                                        {% if form.location.errors %}
                                        <p class="text-error text-xs mt-1">{{ form.location.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Details -->
                        <div class="p-8 form-section" style="--delay: 1">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Additional Details</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- URL and Salary -->
                                <div>
                                    <label for="{{ form.url.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Job URL
                                    </label>
                                    {{ form.url }}
                                    {% if form.url.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.url.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                <div>
                                    <label for="{{ form.salary_range.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Salary Range
                                    </label>
                                    {{ form.salary_range }}
                                    {% if form.salary_range.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.salary_range.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Skills -->
                        <div class="p-8 form-section" style="--delay: 2">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Required Skills</h2>
                            
                            <!-- Simplified skills container -->
                            <div class="skill-container" onclick="document.getElementById('skills-modal').showModal()">
                                <div id="selected-skills" class="p-4 flex flex-wrap gap-2"></div>
                                <!-- Empty state CTA -->
                                <div class="empty-state flex items-center justify-center absolute inset-0">
                                    <div class="flex flex-col items-center gap-3 text-base-content/50">
                                        <iconify-icon icon="heroicons:plus-circle" class="text-4xl"></iconify-icon>
                                        <span class="text-sm font-medium">Add Skills</span>
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" name="required_skills" id="skills-input">
                        </div>

                        <!-- Skills Modal -->
                        <dialog id="skills-modal" class="modal">
                            <!-- Letter preview elements in modal -->
                            <div class="letter-magnifier hidden"></div>
                            <div class="letter-preview hidden"></div>
                            
                            <div class="modal-box w-screen h-screen sm:w-11/12 sm:h-[85vh] sm:max-w-7xl p-0 m-0 sm:m-auto fixed inset-0 sm:relative sm:inset-auto sm:rounded-2xl">
                                <div class="flex flex-col h-full">
                                    <!-- Header -->
                                    <div class="flex-none p-3 sm:p-6 border-b border-base-200 bg-base-100">
                                        <div class="flex items-center justify-between gap-4 mb-3 sm:mb-4">
                                            <h3 class="text-lg sm:text-2xl font-bold">Select Skills</h3>
                                        </div>
                                        <!-- Search input -->
                                        <div class="form-control">
                                            <div class="relative">
                                                <input type="text" 
                                                       placeholder="Search" 
                                                       class="input input-md sm:input-lg input-bordered w-full pl-12" 
                                                       id="skill-search">
                                                <iconify-icon icon="heroicons:magnifying-glass" 
                                                             class="absolute left-4 top-1/2 -translate-y-1/2 text-base-content/50"
                                                             width="20"></iconify-icon>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Main content area -->
                                    <div class="flex-1 overflow-y-auto relative pb-20">
                                        <div class="relative min-h-full overflow-x-hidden"> <!-- Added overflow-x-hidden -->
                                            <!-- Quick letters -->
                                            <div class="quick-letters-list">
                                                {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                                                <button class="quick-letter" data-letter="{{ letter }}">{{ letter }}</button>
                                                {% endfor %}
                                            </div>

                                            <!-- Skills groups -->
                                            <div class="pr-8">
                                                {% for group in skill_icons %}
                                                    <div class="skill-group" data-letter="{{ group.letter }}">
                                                        <div class="sticky top-0 z-20 bg-base-100 shadow-sm">
                                                            <div class="flex items-center gap-3 p-3 sm:p-4">
                                                                <span class="text-2xl sm:text-3xl font-bold text-primary w-10 h-10 flex items-center justify-center">
                                                                    {{ group.letter }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-2 p-2 sm:p-4">
                                                            {% for skill in group.skills %}
                                                                <label class="group flex items-center gap-2 p-2 sm:p-3 rounded-xl hover:bg-base-200 cursor-pointer transition-all duration-200 hover:shadow-md active:scale-[0.98]">
                                                                    <input type="checkbox" 
                                                                           class="checkbox checkbox-sm sm:checkbox-md checkbox-primary" 
                                                                           value="{{ skill.name }}"
                                                                           data-skill='{"name": "{{ skill.name }}", "icon": "{{ skill.icon }}", "icon_dark": "{{ skill.icon_dark|default:skill.icon }}"}'>
                                                                    <div class="flex items-center gap-3 min-w-0 flex-1">
                                                                        <iconify-icon data-icon="{{ skill.icon }}" 
                                                                                    data-icon-dark="{{ skill.icon_dark|default:skill.icon }}"
                                                                                    class="w-8 h-8 sm:w-12 sm:h-12 bg-base-200 rounded-lg group-hover:bg-base-300 transition-colors transform transition-transform duration-200 group-hover:scale-110 flex-shrink-0"
                                                                                    style="display: inline-block; font-size: 32px;"
                                                                                    height="none"></iconify-icon>
                                                                        <span class="text-sm sm:text-base font-medium truncate flex-1">{{ skill.name }}</span>
                                                                    </div>
                                                                </label>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Footer -->
                                    <div class="flex-none border-t border-base-200 bg-base-100">
                                        <div class="p-3 flex justify-end gap-3">
                                            <button type="button" 
                                                    class="btn btn-sm sm:btn-md btn-ghost" 
                                                    onclick="document.getElementById('skills-modal').close(); window.skillsManager.resetModalState()">
                                                <iconify-icon icon="heroicons:x-mark-20-solid" class="text-lg"></iconify-icon>
                                                <span>Cancel</span>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-sm sm:btn-md btn-primary"
                                                    onclick="window.skillsManager.applySelectedSkills(); document.getElementById('skills-modal').close()">
                                                <iconify-icon icon="heroicons:check-20-solid" class="text-lg"></iconify-icon>
                                                <span>Apply</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Modal backdrop -->
                            <form method="dialog" class="modal-backdrop">
                                <button aria-label="Close modal" class="sr-only" onclick="window.skillsManager.resetModalState()">close</button>
                            </form>
                        </dialog>

                        <!-- Status -->
                        <div class="p-8 form-section" style="--delay: 3">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Application Status</h2>
                            <div>
                                <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                    Application Status
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                <p class="text-error text-xs mt-1">{{ form.status.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="p-8 form-section" style="--delay: 4">
                            <h2 class="text-lg font-semibold text-base-content mb-6">Job Description</h2>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-base-content">
                                        Job Description
                                        <span class="ml-1 text-xs text-base-content/60">(Markdown supported)</span>
                                    </label>
                                    <span class="text-xs text-base-content/60" id="char-counter">0/4000</span>
                                </div>
                                {{ form.description }}
                                {% if form.description.errors %}
                                <p class="text-error text-xs mt-1">{{ form.description.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="fixed bottom-0 left-0 right-0 z-10 flex justify-between items-center p-8 bg-base-200 border-t border-base-300 lg:left-[20rem] form-actions">
                            <div class="text-sm text-base-content/60">
                                <span class="text-error">*</span> Required fields
                            </div>
                            <div class="flex space-x-4">
                                <a href="{% url 'jobs:list' %}"
                                   class="btn btn-ghost"
                                   onclick="return handleCancel(event)">
                                    Cancel
                                </a>
                                <button type="submit"
                                        class="btn btn-primary">
                                    Save Job
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Listen for htmx:afterRequest events
    htmx.on('htmx:afterRequest', function(evt) {
        if (evt.detail.successful) {
            try {
                const response = JSON.parse(evt.detail.xhr.response);
                console.log('Response:', response); // Debug log
                
                if (response.status === 'success' && response.fields) {
                    // Populate form fields
                    Object.entries(response.fields).forEach(([key, value]) => {
                        const input = document.getElementById(`id_${key}`);
                        if (input) {
                            console.log(`Setting ${key} to:`, value); // Debug log
                            input.value = value;
                            
                            // Special handling for textareas
                            if (input.tagName.toLowerCase() === 'textarea') {
                                input.style.height = 'auto';
                                input.style.height = `${input.scrollHeight}px`;
                            }
                            
                            input.dispatchEvent(new Event('change'));
                        } else {
                            console.warn(`Field not found: id_${key}`);
                        }
                    });
                    
                    showNotification('Success', 'Job details extracted successfully!', 'success');
                } else {
                    showNotification('Error', response.message || 'Failed to parse job description', 'error');
                }
            } catch (e) {
                console.error('Error:', e);
                showNotification('Error', 'Failed to process response', 'error');
            }
        } else {
            console.error('Request failed:', evt.detail.xhr.status);
            showNotification('Error', 'Request failed', 'error');
        }
    });

    function showNotification(title, message, type = 'info') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} fixed top-4 right-4 z-50 w-96 shadow-lg`;
        alert.innerHTML = `
            <div class="flex items-start">
                <div class="flex-1">
                    <h3 class="font-bold">${title}</h3>
                    <div class="text-sm">${message}</div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="btn btn-ghost btn-sm">×</button>
            </div>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }
});
</script>
{% endblock %}