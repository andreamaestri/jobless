{% extends "base.html" %}
{% load static %}
{% load job_tags %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/css/tom-select.css" rel="stylesheet">
{{ block.super }}
{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col page-transition-wrapper">
    <div class="flex-1 overflow-y-auto pb-20 page-enter">
        <div class="p-4 sm:p-6 md:p-8 lg:py-12 lg:px-8">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-base-content">Add New Job</h1>
                        <p class="text-base-content/70 mt-2">Track and manage your job application</p>
                    </div>
                </div>

                <div class="bg-base-100 shadow-xl rounded-2xl relative overflow-hidden">
                    <div class="divide-y divide-base-200">
                        <!-- AI Paste Section -->
                        <div class="p-8 form-section bg-gradient-to-br from-primary/5 to-transparent" style="--delay: 0">
                        <div class="flex items-center gap-2 mb-6">
                            <iconify-icon icon="heroicons:sparkles" class="text-2xl text-primary"></iconify-icon>
                            <h2 class="text-lg font-semibold text-base-content">Quick Fill with AI</h2>
                        </div>
                        <div class="space-y-4 relative">
                            <form id="parse-form" method="POST">
                                {% csrf_token %}
                                <div>
                                    <label for="paste" class="block text-sm font-medium text-base-content mb-2">
                                        Paste Job Description
                                        <span class="ml-1 text-xs text-base-content/60">(AI will extract details)</span>
                                    </label>
                                    <textarea id="paste" 
                                              name="paste"
                                              class="textarea textarea-bordered w-full min-h-[120px]"
                                              placeholder="Paste the job description here..."></textarea>
                                </div>
                                <div class="flex justify-end mt-4">
                                    <button type="submit" 
                                            class="btn btn-primary btn-sm gap-2">
                                        <span class="loading loading-spinner loading-sm hidden"></span>
                                        <iconify-icon icon="heroicons:sparkles"></iconify-icon>
                                        <span>Process with AI</span>
                                    </button>
                                </div>
                            </form>
                            </div>
                        </div>
                        </div>

                        <!-- Main Form -->
                        <form method="POST" 
                              id="job-form"
                          action="{% url 'jobs:add' %}"
                          enctype="multipart/form-data"
                          data-debug="true">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="p-4 mb-4 text-sm text-error-content bg-error rounded-lg">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- Basic Information -->
                        <div class="p-8 form-section bg-base-100/50 transition-colors duration-200 hover:bg-base-100" style="--delay: 0">
                            <div class="flex items-center gap-2 mb-6">
                                <iconify-icon icon="heroicons:information-circle" class="text-2xl text-primary"></iconify-icon>
                                <h2 class="text-lg font-semibold text-base-content">Basic Information</h2>
                            </div>
                            <div class="grid grid-cols-1 gap-6">
                                <!-- Title -->
                                <div>
                                    <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Job Title <span class="text-error">*</span>
                                    </label>
                                    {{ form.title }}
                                    <p class="text-xs text-base-content/60 mt-1">Enter the official job title as listed in the posting</p>
                                    {% if form.title.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.title.errors.0 }}</p>
                                    {% endif %}
                                </div>

                                <!-- Company and Location -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="{{ form.company.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                            Company <span class="text-error">*</span>
                                        </label>
                                        {{ form.company }}
                                        {% if form.company.errors %}
                                        <p class="text-error text-xs mt-1">{{ form.company.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                            Location <span class="text-error">*</span>
                                        </label>
                                        {{ form.location }}
                                        <p class="text-xs text-base-content/60 mt-1">City, State or Remote</p>
                                        {% if form.location.errors %}
                                        <p class="text-error text-xs mt-1">{{ form.location.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Details -->
                        <div class="p-8 form-section" style="--delay: 1">
                            <div class="flex items-center gap-2 mb-6">
                                <iconify-icon icon="heroicons:clipboard-document-list" class="text-2xl text-primary"></iconify-icon>
                                <h2 class="text-lg font-semibold text-base-content">Additional Details</h2>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- URL and Salary -->
                                <div>
                                    <label for="{{ form.url.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Job URL
                                    </label>
                                    {{ form.url }}
                                    {% if form.url.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.url.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                <div>
                                    <label for="{{ form.salary_range.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                        Salary Range
                                    </label>
                                    {{ form.salary_range }}
                                    {% if form.salary_range.errors %}
                                    <p class="text-error text-xs mt-1">{{ form.salary_range.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Skills -->
                        <div class="p-8 form-section" style="--delay: 2">
                            <div class="flex items-center gap-2 mb-6">
                                <iconify-icon icon="heroicons:academic-cap" class="text-2xl text-primary"></iconify-icon>
                                <h2 class="text-lg font-semibold text-base-content">Required Skills</h2>
                            </div>
                            
                            <div class="relative">
                                <div class="skill-container min-h-[120px] border border-base-300 rounded-lg transition-all duration-200 hover:border-primary/50 cursor-pointer" 
                                     x-data 
                                     @click="$dispatch('open-skills-modal')">
                                    <div id="selected-skills" class="p-4 flex flex-wrap gap-2">
                                        <!-- Skills will be inserted here -->
                                    </div>
                                    <!-- Empty state CTA -->
                                    <div class="empty-state flex items-center justify-center absolute inset-0">
                                        <div class="flex flex-col items-center gap-3 text-base-content/50 group-hover:text-primary/70">
                                            <iconify-icon icon="heroicons:plus-circle" class="text-4xl transition-colors"></iconify-icon>
                                            <span class="text-sm font-medium">Click to Add Skills</span>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="required_skills" id="skills-input">
                                <p class="text-xs text-base-content/60 mt-2">Click to select required skills for this position</p>
                            </div>
                        </div>

                            <div x-data="skillsModal" @open-skills-modal.window="open = true">
                                {% include "jobs/modals/skills_modal.html" %}
                            </div>

                        <!-- Status -->
                        <div class="p-8 form-section" style="--delay: 3">
                            <div class="flex items-center gap-2 mb-6">
                                <iconify-icon icon="heroicons:flag" class="text-2xl text-primary"></iconify-icon>
                                <h2 class="text-lg font-semibold text-base-content">Application Status</h2>
                            </div>
                            <div>
                                <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                    Application Status
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                <p class="text-error text-xs mt-1">{{ form.status.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="p-8 form-section" style="--delay: 4">
                            <div class="flex items-center gap-2 mb-6">
                                <iconify-icon icon="heroicons:document-text" class="text-2xl text-primary"></iconify-icon>
                                <h2 class="text-lg font-semibold text-base-content">Job Description</h2>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-base-content">
                                        Job Description
                                        <span class="ml-1 text-xs text-base-content/60">(Markdown supported)</span>
                                    </label>
                                    <span class="text-xs text-base-content/60" id="char-counter">0/4000</span>
                                </div>
                                {{ form.description }}
                                {% if form.description.errors %}
                                <p class="text-error text-xs mt-1">{{ form.description.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Form Actions (outside form but controls it) -->
<div class="fixed bottom-0 left-0 right-0 z-10 flex justify-between items-center px-8 py-6 bg-base-100 border-t border-base-200 shadow-lg backdrop-blur-sm bg-opacity-90 lg:left-[20rem] form-actions">
    <div class="text-sm text-base-content/60">
        <span class="text-error">*</span> Required fields
    </div>
    <div class="flex space-x-4">
        <a href="{% url 'jobs:list' %}"
           class="btn btn-ghost">
            Cancel
        </a>
        <button type="submit" 
                class="btn btn-primary gap-2 min-w-[120px]"
                form="job-form">
            <span class="loading loading-spinner loading-sm hidden"></span>
            <span class="button-text">Save Job</span>
            <iconify-icon icon="heroicons:arrow-right" class="text-lg"></iconify-icon>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
<script src="{% static 'js/toast.js' %}"></script>
<script src="{% static 'js/skills-manager.js' %}"></script>
<script src="{% static 'js/job-form.js' %}"></script>

<!-- Toast Container -->
<template x-teleport="body">
    <ul 
        x-data="{ toastsHovered: false }"
        @mouseenter="toastsHovered = true"
        @mouseleave="toastsHovered = false"
        class="fixed block w-full group z-[99] sm:max-w-xs"
        :class="{
            'right-0 top-0 sm:mt-6 sm:mr-6': $store.toastManager.position === 'top-right',
            'left-0 top-0 sm:mt-6 sm:ml-6': $store.toastManager.position === 'top-left',
            'left-1/2 -translate-x-1/2 top-0 sm:mt-6': $store.toastManager.position === 'top-center',
            'right-0 bottom-0 sm:mr-6 sm:mb-6': $store.toastManager.position === 'bottom-right',
            'left-0 bottom-0 sm:ml-6 sm:mb-6': $store.toastManager.position === 'bottom-left',
            'left-1/2 -translate-x-1/2 bottom-0 sm:mb-6': $store.toastManager.position === 'bottom-center'
        }">
        <template x-for="toast in $store.toastManager.toasts" :key="toast.id">
            <li :id="toast.id"
                class="absolute w-full duration-300 ease-out select-none sm:max-w-xs"
                :class="{ 'toast-no-description': !toast.description }">
                <div class="relative flex flex-col items-start shadow-lg w-full transition-all duration-300 ease-out bg-white border border-gray-100 sm:rounded-lg sm:max-w-xs group p-4">
                    <div class="relative">
                        <div class="flex items-center" :class="{
                            'text-green-500': toast.type === 'success',
                            'text-blue-500': toast.type === 'info',
                            'text-orange-400': toast.type === 'warning',
                            'text-red-500': toast.type === 'error',
                            'text-gray-800': toast.type === 'default'
                        }">
                            <!-- Icons for different types -->
                            <template x-if="toast.type === 'success'">
                                <svg class="w-[18px] h-[18px] mr-1.5 -ml-1" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2ZM16.7744 9.63269C17.1238 9.20501 17.0604 8.57503 16.6327 8.22559C16.2051 7.87615 15.5751 7.93957 15.2256 8.36725L10.6321 13.9892L8.65936 12.2524C8.24484 11.8874 7.61295 11.9276 7.248 12.3421C6.88304 12.7566 6.92322 13.3885 7.33774 13.7535L9.31046 15.4903C10.1612 16.2393 11.4637 16.1324 12.1808 15.2547L16.7744 9.63269Z" fill="currentColor"/></svg>
                            </template>
                            <p class="text-sm font-medium leading-none" x-text="toast.message"></p>
                        </div>
                        <p x-show="toast.description" 
                           class="mt-1.5 text-xs leading-none text-gray-600" 
                           x-text="toast.description"></p>
                    </div>
                    <button @click="$store.toastManager.remove(toast.id)"
                            class="absolute right-2 top-2 p-1.5 rounded-full text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/></svg>
                    </button>
                </div>
            </li>
        </template>
    </ul>
</template>

<script>
    console.log('Template script starting');
    window.addEventListener('load', function() {
        console.log('Window loaded');
    });
</script>
{% endblock %}
